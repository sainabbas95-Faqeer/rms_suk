<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RMS Brands Analysis</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            min-height: 100vh;
            color: #fff;
            padding: 20px;
            overflow-x: hidden;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Floating back button */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            animation: floating 3s ease-in-out infinite;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-5px);
        }

        .back-button i {
            font-size: 24px;
            color: #333;
        }

        /* Fixed header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px 40px;
            border-radius: 20px;
            margin-bottom: 35px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: float 6s ease-in-out infinite;
            border: 1px solid rgba(255, 255, 255, 0.3);
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 70%);
            transform: rotate(30deg);
            animation: shine 8s infinite linear;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }

        @keyframes shine {
            0% { transform: rotate(30deg) translateX(-100%); }
            100% { transform: rotate(30deg) translateX(100%); }
        }

        .header .logo {
            position: absolute;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            height: 70px;
            width: auto;
            cursor: pointer;
            transition: transform 0.3s ease;
            border: 2px dashed transparent;
            border-radius: 10px;
        }
        
        .header .logo.processing {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        
        .header .logo.drag-over {
            border-color: #1a2a6c;
            box-shadow: 0 0 20px rgba(26, 42, 108, 0.8);
            transform: translateY(-50%) scale(1.15);
        }

        .header .logo:hover {
            transform: translateY(-50%) scale(1.1);
            border-color: #1a2a6c;
            box-shadow: 0 0 15px rgba(26, 42, 108, 0.5);
        }

        .header .logo::after {
            content: 'Click to upload XLSX';
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #1a2a6c;
            background: rgba(255, 255, 255, 0.8);
            padding: 2px 8px;
            border-radius: 10px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .header .logo:hover::after {
            opacity: 1;
        }

        .header .header-content {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .header h1 {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 2.8rem;
            margin-bottom: 10px;
            color: #333;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-weight: 800;
            letter-spacing: 1px;
        }

        .header .date-info {
            position: absolute;
            top: 25px;
            right: 30px;
            font-size: 14px;
            color: #00008B;
            font-weight: bold;
            text-align: right;
            background: rgba(255, 255, 255, 0.7);
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .header p {
            text-align: center;
            color: #666;
            margin: 5px 0 0 0;
            font-size: 16px;
            font-weight: 500;
        }

        .footer-text {
            position: fixed;
            bottom: 15px;
            right: 15px;
            font-size: 14px;
            color: #fff;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 15px;
            border-radius: 10px;
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: floating 3s ease-in-out infinite;
        }

        .visit-counter {
            position: fixed;
            bottom: 50px;
            right: 15px;
            font-size: 14px;
            color: #fff;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 15px;
            border-radius: 10px;
            z-index: 1000;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            animation: floating 3s ease-in-out infinite;
            animation-delay: 0.5s;
        }

        .visit-counter:hover {
            background: rgba(0, 0, 0, 0.5);
            transform: translateY(-3px);
        }

        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        /* Status and loading */
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: bold;
            text-align: center;
        }

        .success {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
            border: 2px solid #28a745;
        }

        .error {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 2px solid #dc3545;
        }

        .loading {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
            border: 2px solid #ffc107;
        }

        /* Results section */
        .results-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            color: #333;
        }

        .section-title {
            color: #1a2a6c;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            border-bottom: 2px solid #1a2a6c;
            padding-bottom: 10px;
        }

        /* Stats grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            transform: perspective(1000px) rotateX(0deg);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: perspective(1000px) rotateX(-5deg) translateY(-5px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }

        .stat-number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .stat-label {
            font-size: 1.2em;
            opacity: 0.9;
        }

        /* Charts section */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; /* Fixed three equal columns */
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .chart-wrapper {
            position: relative;
            height: 350px; /* Reduced height for better fit */
            margin: 20px 0;
        }

        /* Brand details modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 1200px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #dc3545;
        }

        .modal-header {
            color: #1a2a6c;
            font-size: 24px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #1a2a6c;
        }

        /* Data table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .data-table th {
            background-color: #1a2a6c;
            color: white;
            position: sticky;
            top: 0;
        }

        .data-table tr:hover {
            background-color: #f5f5f5;
        }

        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        /* Responsive design */
        @media (max-width: 1200px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .charts-container {
                grid-template-columns: 1fr; /* Stack charts on smaller screens */
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .data-table {
                font-size: 12px;
            }
            
            .data-table th, .data-table td {
                padding: 8px 10px;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .results-section {
                padding: 15px;
            }
            
            .modal-content {
                width: 95%;
                padding: 15px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .results-section {
                padding: 15px;
            }
            
            .modal-content {
                width: 95%;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Back button -->
        <div class="back-button" onclick="window.location.href='welcome.html'" title="Back to Welcome Page">
            <i class="fas fa-arrow-left"></i>
        </div>

        <div class="header">
            <img src="Logo.jpeg" alt="RMS Logo" class="logo" title="Click to upload XLSX file">
            <div class="date-info" id="dateInfo">Data till<br><span id="displayDate"></span><br><span id="displayTime" style="color: red; font-weight: bold;"></span></div>
            <div class="header-content">
                <h1><i class="fas fa-tags"></i> RMS Brands Analysis</h1>
                <p>Comprehensive Analysis of Installed RMS Device Brands</p>
            </div>
        </div>

        <!-- Footer text -->
        <div class="footer-text">Database created by - Abbas Enterprises - Lakhi - 2025</div>
        
        <!-- Visit counter -->
        <div class="visit-counter" id="visitCounter" onclick="openVisitHistory()">Page Visits: <span id="visitCount">0</span></div>

        <!-- Hidden file input for logo click -->
        <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls" style="display: none;" />
        
        <!-- File upload status -->
        <div id="fileUploadStatus" class="status" style="display: none; margin: 10px 0;"></div>

        <!-- Status display -->
        <div id="status"></div>

        <!-- Results section -->
        <div class="results-section" id="resultsSection">
            <!-- Summary statistics -->
            <div class="stats-grid" id="statsGrid">
                <!-- Stats will be populated here -->
            </div>

            <!-- Charts section -->
            <!-- First row with three charts -->
            <div class="charts-container">
                <div class="chart-container">
                    <h3 class="section-title">Brand Distribution</h3>
                    <div class="chart-wrapper">
                        <canvas id="brandPieChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 class="section-title">Cluster-wise Brand Count</h3>
                    <div class="chart-wrapper">
                        <canvas id="clusterBarChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 class="section-title">Brand Installation Trends</h3>
                    <div class="chart-wrapper">
                        <canvas id="trendsBarChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Second row with Sub Region-wise Brand Count chart -->
            <div class="charts-container" style="grid-template-columns: 1fr;">
                <div class="chart-container">
                    <h3 class="section-title">Sub Region-wise Brand Count</h3>
                    <div class="chart-wrapper">
                        <canvas id="subRegionBarChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Brand details modal -->
    <div id="brandModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 class="modal-header" id="modalTitle">Brand Details</h2>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // Register the datalabels plugin with Chart.js
        Chart.register(ChartDataLabels);

        // Set the date in header (previous day) and current time
        function setPreviousDate() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            const dayName = days[yesterday.getDay()];
            const monthName = months[yesterday.getMonth()];
            const date = yesterday.getDate();
            const year = yesterday.getFullYear();
            
            const formattedDate = `${dayName}, ${monthName} ${date < 10 ? '0' + date : date}, ${year}`;
            document.getElementById('displayDate').textContent = formattedDate;
            
            // Update time
            updateTime();
        }
        
        // Function to update current time
        function updateTime() {
            const now = new Date();
            let hours = now.getHours();
            let minutes = now.getMinutes();
            let seconds = now.getSeconds();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            
            hours = hours % 12;
            hours = hours ? hours : 12; // 0 should be 12
            minutes = minutes < 10 ? '0' + minutes : minutes;
            seconds = seconds < 10 ? '0' + seconds : seconds;
            
            const timeString = `${hours}:${minutes}:${seconds} ${ampm}`;
            const timeElement = document.getElementById('displayTime');
            if (timeElement) {
                timeElement.textContent = timeString;
            }
        }
        
        // Call on page load
        setPreviousDate();
        
        // Update time every second
        setInterval(updateTime, 1000);

        // Show status message
        function showStatus(message, type) {
            const status = document.getElementById('status');
            if (status) {
                status.innerHTML = `<div class="status ${type}">${message}</div>`;
                status.style.display = 'block';
                
                // Auto-hide success messages after 5 seconds
                if (type === 'success') {
                    setTimeout(() => {
                        status.style.display = 'none';
                    }, 5000);
                }
            }
        }

        // Brand data storage
        let brandData = {};
        let rawData = [];
        let clusterData = {};
        let subRegionData = {};

        // File upload handling for logo click
        function triggerFileUpload() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.click();
            } else {
                console.error('File input element not found');
                showStatus('âŒ File upload element not found', 'error');
            }
        }

        // DOM ready function
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing components...');
            
            // Initialize date and time
            setPreviousDate();
            setInterval(updateTime, 1000);
            
            // Initialize drag and drop functionality
            initDragAndDrop();
            
            // Initialize with existing XLSX Files/DB.xlsx if available
            initializeData();
        });

        // Initialize drag and drop functionality
        function initDragAndDrop() {
            const logo = document.querySelector('.logo');
            const fileInput = document.getElementById('fileInput');
            const body = document.body;
            
            console.log('Initializing drag and drop functionality...');
            console.log('Logo element found:', !!logo);
            console.log('File input element found:', !!fileInput);
            console.log('Body element found:', !!body);
            
            // Add event listener for logo click
            if (logo) {
                logo.addEventListener('click', triggerFileUpload);
                console.log('Click event listener added to logo');
            } else {
                console.error('Logo element not found');
            }
            
            // File input change handler
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
                console.log('Change event listener added to file input');
            } else {
                console.error('File input element not found');
            }
            
            // Drag and drop events for body
            if (body) {
                body.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    if (logo) {
                        logo.classList.add('drag-over');
                    }
                });
                
                body.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    if (logo) {
                        logo.classList.remove('drag-over');
                    }
                });
                
                body.addEventListener('drop', function(e) {
                    e.preventDefault();
                    if (logo) {
                        logo.classList.remove('drag-over');
                    }
                    
                    if (e.dataTransfer.files.length) {
                        if (fileInput) {
                            fileInput.files = e.dataTransfer.files;
                            handleFileSelect();
                        }
                    }
                });
                console.log('Drag and drop event listeners added to body');
            }
        }

        // Handle file selection
        function handleFileSelect() {
            console.log('handleFileSelect called');
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const logo = document.querySelector('.logo');
            
            console.log('File selected:', file);
            
            if (file) {
                if (!file.name.match(/\.(xlsx|xls)$/)) {
                    showStatus('âŒ Please select a valid Excel file (.xlsx or .xls)', 'error');
                    return;
                }
                
                showStatus('ðŸ”„ Processing Excel file...', 'loading');
                if (logo) {
                    logo.classList.add('processing');
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        console.log('Excel file processed, row count:', jsonData.length);
                        
                        // Store in localStorage
                        try {
                            localStorage.setItem('rmsExcelData', JSON.stringify(jsonData));
                            localStorage.setItem('rmsDataLoaded', 'true');
                            console.log('Data saved to localStorage');
                        } catch (storageError) {
                            console.warn('Could not save to localStorage:', storageError);
                        }
                        
                        rawData = jsonData;
                        processBrandData(rawData);
                        if (logo) {
                            logo.classList.remove('processing');
                        }
                    } catch (error) {
                        console.error('Error processing Excel file:', error);
                        showStatus('âŒ Error processing Excel file: ' + error.message, 'error');
                        if (logo) {
                            logo.classList.remove('processing');
                        }
                    }
                };
                reader.onerror = function() {
                    console.error('Error reading file');
                    showStatus('âŒ Error reading file', 'error');
                    if (logo) {
                        logo.classList.remove('processing');
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                console.log('No file selected');
            }
        }

        // Initialize data - try localStorage first, then auto-load DB.xlsx
        function initializeData() {
            console.log('=== Initializing RMS Brands Analysis ===');
            
            // Check if data exists in localStorage first
            const storedData = localStorage.getItem('rmsExcelData');
            const dataLoaded = localStorage.getItem('rmsDataLoaded');
            
            if (storedData && dataLoaded === 'true') {
                try {
                    console.log('Loading data from localStorage...');
                    const jsonData = JSON.parse(storedData);
                    
                    if (jsonData && jsonData.length > 0) {
                        showStatus('âœ… Loading saved data...', 'success');
                        console.log('Loaded data from localStorage, row count:', jsonData.length);
                        
                        rawData = jsonData;
                        processBrandData(rawData);
                        
                        return; // Exit if localStorage data loaded successfully
                    }
                } catch (error) {
                    console.warn('Error loading from localStorage:', error);
                    localStorage.removeItem('rmsExcelData');
                    localStorage.removeItem('rmsDataLoaded');
                }
            }
            
            // If no localStorage data, try to automatically load DB.xlsx from XLSX Files folder
            console.log('Attempting to load DB.xlsx from XLSX Files folder...');
            fetch('XLSX Files/DB.xlsx')
                .then(response => {
                    console.log('XLSX Files/DB.xlsx fetch response status:', response.status);
                    if (!response.ok) {
                        throw new Error('XLSX Files/DB.xlsx not found (' + response.status + ')');
                    }
                    return response.arrayBuffer();
                })
                .then(data => {
                    console.log('XLSX Files/DB.xlsx loaded successfully, processing data...');
                    showStatus('ðŸ”„ Auto-loading XLSX Files/DB.xlsx...', 'loading');
                    const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    console.log('XLSX Files/DB.xlsx data processed, row count:', jsonData.length);
                    if (jsonData.length > 0) {
                        // Store in localStorage
                        try {
                            localStorage.setItem('rmsExcelData', JSON.stringify(jsonData));
                            localStorage.setItem('rmsDataLoaded', 'true');
                            console.log('Data saved to localStorage');
                        } catch (storageError) {
                            console.warn('Could not save to localStorage:', storageError);
                        }
                        
                        rawData = jsonData;
                        processBrandData(rawData);
                    } else {
                        console.log('XLSX Files/DB.xlsx is empty');
                        // Show the results section even if empty to ensure UI is visible
                        document.getElementById('resultsSection').style.display = 'block';
                    }
                })
                .catch(error => {
                    console.log('XLSX Files/DB.xlsx not found or could not be loaded:', error.message);
                    showStatus('â„¹ï¸ No data loaded. Please upload an Excel file.', 'loading');
                    // Show the results section even if there's an error to ensure UI is visible
                    document.getElementById('resultsSection').style.display = 'block';
                });
        }

        // Process brand data from Column B (index 1)
        function processBrandData(data) {
            console.log('=== Processing Brand Data ===');
            showStatus('ðŸ” Analyzing RMS Brands...', 'loading');
            
            try {
                // Validate data first
                if (!data || !Array.isArray(data) || data.length === 0) {
                    throw new Error('Invalid data format or empty dataset');
                }
                
                console.log('Data structure:', data);
                console.log('Total rows to process:', data.length);
                
                rawData = data; // Store for detailed analysis
                brandData = {};
                clusterData = {};
                subRegionData = {};
                
                // Log the header row to understand column mapping
                if (data.length > 0 && data[0]) {
                    console.log('Header row:', data[0]);
                }
                
                // Skip header row, analyze from row 1 onwards
                // Limit processing to prevent performance issues with large files
                const maxRows = 10000; // Limit to 10,000 rows for performance
                const rowsToProcess = Math.min(data.length, maxRows);
                
                console.log('Processing rows 1 to', rowsToProcess - 1);
                
                for (let i = 1; i < rowsToProcess; i++) {
                    const row = data[i];
                    
                    // Check if row exists and has enough columns
                    if (!row || !Array.isArray(row) || row.length < 2) {
                        console.warn(`Row ${i} is invalid or has insufficient columns:`, row);
                        continue;
                    }
                    
                    // Log first few data rows to understand structure
                    if (i < 5) {
                        console.log(`Data row ${i}:`, row);
                    }
                    
                    // Column B (index 1) contains brand information
                    const brand = row[1]; // Column B
                    const cluster = row[3]; // Column D (Cluster/Region)
                    const subRegion = row[2]; // Column C (Sub Region) - Changed from row[4]
                    
                    // Skip rows where brand is "RMS NA"
                    if (!brand || brand === '' || brand === null || brand === undefined || String(brand).trim().toUpperCase() === 'RMS NA') {
                        continue;
                    }
                    
                    const brandStr = String(brand).trim();
                    
                    // Count brands
                    if (!brandData[brandStr]) {
                        brandData[brandStr] = 0;
                    }
                    brandData[brandStr]++;
                    
                    // Count by cluster
                    if (cluster && cluster !== '') {
                        const clusterStr = String(cluster).trim();
                        if (!clusterData[clusterStr]) {
                            clusterData[clusterStr] = {};
                        }
                        if (!clusterData[clusterStr][brandStr]) {
                            clusterData[clusterStr][brandStr] = 0;
                        }
                        clusterData[clusterStr][brandStr]++;
                    }
                    
                    // Count by sub-region
                    if (subRegion && subRegion !== '') {
                        const subRegionStr = String(subRegion).trim();
                        if (!subRegionData[subRegionStr]) {
                            subRegionData[subRegionStr] = {};
                        }
                        if (!subRegionData[subRegionStr][brandStr]) {
                            subRegionData[subRegionStr][brandStr] = 0;
                        }
                        subRegionData[subRegionStr][brandStr]++;
                    }
                }
                
                console.log('Brand analysis results:', brandData);
                console.log('Cluster analysis results:', clusterData);
                console.log('Sub-region analysis results:', subRegionData);
                
                // Display results
                displayResults();
                
                showStatus('âœ… Brand analysis completed successfully!', 'success');
                
            } catch (error) {
                console.error('Analysis error:', error);
                showStatus('âŒ Error analyzing brand data: ' + error.message, 'error');
            }
        }

        // Display results
        function displayResults() {
            document.getElementById('resultsSection').style.display = 'block';
            
            // Populate stats cards
            const statsGrid = document.getElementById('statsGrid');
            if (statsGrid) {
                // Calculate total brands and unique brands
                const totalBrands = Object.values(brandData).reduce((sum, count) => sum + count, 0);
                const uniqueBrands = Object.keys(brandData).length;
                
                statsGrid.innerHTML = `
                    <div class="stat-card" onclick="showAllBrands()" style="cursor: pointer;" title="Click to view all brands">
                        <div class="stat-number">${uniqueBrands}</div>
                        <div class="stat-label">Unique Brands</div>
                    </div>
                    <div class="stat-card" onclick="showAllInstallations()" style="cursor: pointer;" title="Click to view all installations">
                        <div class="stat-number">${totalBrands}</div>
                        <div class="stat-label">Total Installations</div>
                    </div>
                    <div class="stat-card" onclick="showTopBrands()" style="cursor: pointer;" title="Click to view top brands">
                        <div class="stat-number">${Object.keys(brandData).sort((a, b) => brandData[b] - brandData[a])[0] || 'N/A'}</div>
                        <div class="stat-label">Most Popular Brand</div>
                    </div>
                `;
            }
            
            // Create charts
            createBrandPieChart();
            createClusterBarChart();
            createSubRegionBarChart();
            createTrendsBarChart();
        }

        // Create brand distribution pie chart
        let brandPieChartInstance = null;
        function createBrandPieChart() {
            const canvas = document.getElementById('brandPieChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart if any
            if (brandPieChartInstance) {
                brandPieChartInstance.destroy();
            }
            
            // Get top 10 brands for better visualization and performance
            const sortedBrands = Object.entries(brandData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const labels = sortedBrands.map(item => item[0]);
            const data = sortedBrands.map(item => item[1]);
            
            // Generate colors
            const colors = generateColors(labels.length);
            
            const chartData = {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors,
                    borderColor: '#fff',
                    borderWidth: 2,
                    hoverOffset: 15
                }]
            };
            
            const config = {
                type: 'pie',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 12,
                                    weight: 'bold',
                                    family: 'Segoe UI'
                                },
                                color: '#000',
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw;
                                    const total = data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            },
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            titleFont: {
                                weight: 'bold'
                            },
                            bodyFont: {
                                weight: 'bold'
                            }
                        },
                        // Add datalabels plugin to show count in center of bars
                        datalabels: {
                            anchor: 'center',
                            align: 'center',
                            color: '#000',
                            font: {
                                weight: 'bold',
                                size: 14
                            },
                            formatter: function(value, context) {
                                const total = data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return value > 0 ? `${value}\n(${percentage}%)` : '';
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 2000,
                        easing: 'easeInOutElastic'
                    },
                    onClick: function(event, elements) {
                        console.log('Pie chart clicked', event, elements);
                        if (elements && elements.length > 0) {
                            const elementIndex = elements[0].index;
                            const brandName = this.data.labels[elementIndex];
                            console.log('Showing details for brand:', brandName);
                            showBrandDetails(brandName);
                        } else {
                            console.log('No elements found in click event');
                        }
                    }

                }
            };
            
            brandPieChartInstance = new Chart(ctx, config);
        }

        // Create cluster-wise bar chart
        let clusterBarChartInstance = null;
        function createClusterBarChart() {
            const canvas = document.getElementById('clusterBarChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart if any
            if (clusterBarChartInstance) {
                clusterBarChartInstance.destroy();
            }
            
            // Get clusters and top 5 brands in each for performance
            const clusters = Object.keys(clusterData).slice(0, 20); // Limit to 20 clusters
            const allBrands = Object.keys(brandData).sort((a, b) => brandData[b] - brandData[a]).slice(0, 5);
            
            // Prepare data for stacked bar chart
            const datasets = allBrands.map((brand, index) => {
                const color = generateColor(index);
                return {
                    label: brand,
                    data: clusters.map(cluster => clusterData[cluster][brand] || 0),
                    backgroundColor: color,
                    borderColor: '#fff',
                    borderWidth: 1
                };
            });
            
            const chartData = {
                labels: clusters,
                datasets: datasets
            };
            
            const config = {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 12,
                                    weight: 'bold',
                                    family: 'Segoe UI'
                                },
                                color: '#000',
                                padding: 10
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw}`;
                                }
                            },
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            titleFont: {
                                weight: 'bold'
                            },
                            bodyFont: {
                                weight: 'bold'
                            }
                        },
                        // Add datalabels plugin to show count in center of bars
                        datalabels: {
                            anchor: 'center',
                            align: 'center',
                            color: '#000',
                            font: {
                                weight: 'bold',
                                size: 14
                            },
                            formatter: function(value) {
                                return value > 0 ? value : '';
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                },
                                color: '#000'
                            },
                            title: {
                                display: true,
                                text: 'Clusters',
                                color: '#000',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        },
                        y: {
                            stacked: true,
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                },
                                color: '#000'
                            },
                            title: {
                                display: true,
                                text: 'Count',
                                color: '#000',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1500,
                        easing: 'easeOutBounce'
                    },
                    onClick: function(event, elements) {
                        console.log('Cluster chart clicked', event, elements);
                        if (elements && elements.length > 0) {
                            // Get the clicked element
                            const element = elements[0];
                            const datasetIndex = element.datasetIndex;
                            const index = element.index;
                            
                            // Get the brand and cluster names
                            const brandName = this.data.datasets[datasetIndex].label;
                            const clusterName = this.data.labels[index];
                            
                            console.log('Showing details for brand:', brandName, 'in cluster:', clusterName);
                            // Show details for this brand in this cluster
                            showClusterBrandDetails(brandName, clusterName);
                        } else {
                            console.log('No elements found in click event');
                        }
                    }

                }
            };
            
            clusterBarChartInstance = new Chart(ctx, config);
        }

        // Create sub-region-wise bar chart
        let subRegionBarChartInstance = null;
        function createSubRegionBarChart() {
            const canvas = document.getElementById('subRegionBarChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart if any
            if (subRegionBarChartInstance) {
                subRegionBarChartInstance.destroy();
            }
            
            // Get sub-regions and top 5 brands in each for performance
            const subRegions = Object.keys(subRegionData).slice(0, 20); // Limit to 20 sub-regions
            const allBrands = Object.keys(brandData).sort((a, b) => brandData[b] - brandData[a]).slice(0, 5);
            
            // Prepare data for stacked bar chart
            const datasets = allBrands.map((brand, index) => {
                const color = generateColor(index + 5); // Different colors
                return {
                    label: brand,
                    data: subRegions.map(subRegion => subRegionData[subRegion][brand] || 0),
                    backgroundColor: color,
                    borderColor: '#fff',
                    borderWidth: 1
                };
            });
            
            const chartData = {
                labels: subRegions,
                datasets: datasets
            };
            
            const config = {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 12,
                                    weight: 'bold',
                                    family: 'Segoe UI'
                                },
                                color: '#000',
                                padding: 10
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw}`;
                                }
                            },
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            titleFont: {
                                weight: 'bold'
                            },
                            bodyFont: {
                                weight: 'bold'
                            }
                        },
                        // Add datalabels plugin to show count in center of bars
                        datalabels: {
                            anchor: 'center',
                            align: 'center',
                            color: '#000',
                            font: {
                                weight: 'bold',
                                size: 14
                            },
                            formatter: function(value) {
                                return value > 0 ? value : '';
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                },
                                color: '#000'
                            },
                            title: {
                                display: true,
                                text: 'Sub Regions',
                                color: '#000',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        },
                        y: {
                            stacked: true,
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                },
                                color: '#000'
                            },
                            title: {
                                display: true,
                                text: 'Count',
                                color: '#000',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1500,
                        easing: 'easeOutBounce'
                    },
                    onClick: function(event, elements) {
                        console.log('Sub-region chart clicked', event, elements);
                        if (elements && elements.length > 0) {
                            // Get the clicked element
                            const element = elements[0];
                            const datasetIndex = element.datasetIndex;
                            const index = element.index;
                            
                            // Get the brand and sub-region names
                            const brandName = this.data.datasets[datasetIndex].label;
                            const subRegionName = this.data.labels[index];
                            
                            console.log('Showing details for brand:', brandName, 'in sub-region:', subRegionName);
                            // Show details for this brand in this sub-region
                            showSubRegionBrandDetails(brandName, subRegionName);
                        } else {
                            console.log('No elements found in click event');
                        }
                    }

                }
            };
            
            subRegionBarChartInstance = new Chart(ctx, config);
        }

        // Create trends bar chart
        let trendsBarChartInstance = null;
        function createTrendsBarChart() {
            const canvas = document.getElementById('trendsBarChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart if any
            if (trendsBarChartInstance) {
                trendsBarChartInstance.destroy();
            }
            
            // Get top 10 brands for trend analysis
            const sortedBrands = Object.entries(brandData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const labels = sortedBrands.map(item => item[0]);
            const data = sortedBrands.map(item => item[1]);
            
            // Generate colors
            const colors = generateColors(labels.length);
            
            const chartData = {
                labels: labels,
                datasets: [{
                    label: 'Installations',
                    data: data,
                    backgroundColor: colors,
                    borderColor: '#fff',
                    borderWidth: 2,
                    borderRadius: 4
                }]
            };
            
            const config = {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Installations: ${context.raw}`;
                                }
                            },
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            titleFont: {
                                weight: 'bold'
                            },
                            bodyFont: {
                                weight: 'bold'
                            }
                        },
                        // Add datalabels plugin to show count in center of bars
                        datalabels: {
                            anchor: 'center',
                            align: 'center',
                            color: '#000',
                            font: {
                                weight: 'bold',
                                size: 14
                            },
                            formatter: function(value) {
                                return value > 0 ? value : '';
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                },
                                color: '#000',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Brands',
                                color: '#000',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                },
                                color: '#000'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            title: {
                                display: true,
                                text: 'Count',
                                color: '#000',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1500,
                        easing: 'easeOutBounce'
                    },
                    onClick: function(event, elements) {
                        console.log('Trends chart clicked', event, elements);
                        if (elements && elements.length > 0) {
                            const elementIndex = elements[0].index;
                            const brandName = this.data.labels[elementIndex];
                            console.log('Showing details for brand:', brandName);
                            showBrandDetails(brandName);
                        } else {
                            console.log('No elements found in click event');
                        }
                    }

                }
            };
            
            trendsBarChartInstance = new Chart(ctx, config);
        }

        // Generate colors for charts
        function generateColors(count) {
            const colors = [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(199, 199, 199, 0.8)',
                'rgba(83, 102, 255, 0.8)',
                'rgba(255, 99, 255, 0.8)',
                'rgba(99, 255, 132, 0.8)'
            ];
            
            const result = [];
            for (let i = 0; i < count; i++) {
                result.push(colors[i % colors.length]);
            }
            return result;
        }

        // Generate single color
        function generateColor(index) {
            const colors = [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(199, 199, 199, 0.8)',
                'rgba(83, 102, 255, 0.8)',
                'rgba(255, 99, 255, 0.8)',
                'rgba(99, 255, 132, 0.8)'
            ];
            return colors[index % colors.length];
        }

        // Show brand details in modal
        function showBrandDetails(brandName) {
            try {
                console.log('showBrandDetails called with brand:', brandName);
                
                // Validate input
                if (!brandName || typeof brandName !== 'string') {
                    console.error('Invalid brand name provided:', brandName);
                    return;
                }
                
                const modal = document.getElementById('brandModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalContent = document.getElementById('modalContent');
                
                if (!modal || !modalTitle || !modalContent) {
                    console.error('Modal elements not found');
                    showStatus('âŒ Error: Modal elements not found', 'error');
                    return;
                }
                
                // Check if rawData is available
                if (!rawData || !Array.isArray(rawData)) {
                    console.error('Raw data not available');
                    modalTitle.textContent = `Installations for Brand: ${brandName}`;
                    modalContent.innerHTML = '<p>Error: Data not available</p>';
                    modal.style.display = 'block';
                    return;
                }
                
                modalTitle.textContent = `Installations for Brand: ${brandName}`;
                
                // Find all entries for this brand
                const brandEntries = [];
                for (let i = 1; i < rawData.length; i++) {
                    const row = rawData[i];
                    if (row && Array.isArray(row) && row.length > 1 && 
                        String(row[1]).trim().toLowerCase() === brandName.trim().toLowerCase()) {
                        brandEntries.push(row);
                    }
                }
                
                console.log('Found', brandEntries.length, 'entries for brand:', brandName);
                
                // Create table with specified columns only
                let tableHTML = `
                    <p><strong>Total Installations:</strong> ${brandEntries.length}</p>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Site Id</th>
                                <th>Device Brand</th>
                                <th>Sub Region</th>
                                <th>Cluster</th>
                                <th>Team lead</th>
                                <th>ES POC</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // Add data rows with only specified columns
                if (brandEntries.length > 0) {
                    brandEntries.forEach((row, index) => {
                        console.log('Processing row', index, ':', row);
                        // Map the columns: Site Id (0), Device Brand (1), Sub Region (2), Cluster (3), Team lead (5), ES POC (6)
                        const siteId = row[0] || '';
                        const deviceBrand = row[1] || '';
                        const subRegion = row[2] || '';
                        const cluster = row[3] || '';
                        const teamLead = row[5] || '';
                        const esPOC = row[6] || '';
                        
                        tableHTML += `
                            <tr>
                                <td>${siteId}</td>
                                <td>${deviceBrand}</td>
                                <td>${subRegion}</td>
                                <td>${cluster}</td>
                                <td>${teamLead}</td>
                                <td>${esPOC}</td>
                            </tr>
                        `;
                    });
                } else {
                    tableHTML += `<tr><td colspan="6">No installations found for brand: ${brandName}</td></tr>`;
                }
                
                tableHTML += `
                        </tbody>
                    </table>
                `;
                
                modalContent.innerHTML = tableHTML;
                modal.style.display = 'block';
                console.log('Modal displayed with content');
            } catch (error) {
                console.error('Error in showBrandDetails:', error);
                showStatus('âŒ Error displaying brand details: ' + error.message, 'error');
            }
        }

        // Show cluster brand details in modal
        function showClusterBrandDetails(brandName, clusterName) {
            try {
                console.log('showClusterBrandDetails called with brand:', brandName, 'cluster:', clusterName);
                
                // Validate inputs
                if (!brandName || typeof brandName !== 'string' || !clusterName || typeof clusterName !== 'string') {
                    console.error('Invalid brand or cluster name provided:', brandName, clusterName);
                    return;
                }
                
                const modal = document.getElementById('brandModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalContent = document.getElementById('modalContent');
                
                if (!modal || !modalTitle || !modalContent) {
                    console.error('Modal elements not found');
                    showStatus('âŒ Error: Modal elements not found', 'error');
                    return;
                }
                
                // Check if rawData is available
                if (!rawData || !Array.isArray(rawData)) {
                    console.error('Raw data not available');
                    modalTitle.textContent = `Installations for Brand: ${brandName} in Cluster: ${clusterName}`;
                    modalContent.innerHTML = '<p>Error: Data not available</p>';
                    modal.style.display = 'block';
                    return;
                }
                
                modalTitle.textContent = `Installations for Brand: ${brandName} in Cluster: ${clusterName}`;
                
                // Find all entries for this brand in this cluster
                const brandEntries = [];
                for (let i = 1; i < rawData.length; i++) {
                    const row = rawData[i];
                    if (row && Array.isArray(row) && row.length > 3 && 
                        String(row[1]).trim().toLowerCase() === brandName.trim().toLowerCase() && 
                        String(row[3]).trim().toLowerCase() === clusterName.trim().toLowerCase()) {
                        brandEntries.push(row);
                    }
                }
                
                console.log('Found', brandEntries.length, 'entries for brand:', brandName, 'in cluster:', clusterName);
                
                // Create table with specified columns only
                let tableHTML = `
                    <p><strong>Total Installations:</strong> ${brandEntries.length}</p>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Site Id</th>
                                <th>Device Brand</th>
                                <th>Sub Region</th>
                                <th>Cluster</th>
                                <th>Team lead</th>
                                <th>ES POC</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // Add data rows with only specified columns
                if (brandEntries.length > 0) {
                    brandEntries.forEach((row, index) => {
                        console.log('Processing row', index, ':', row);
                        // Map the columns: Site Id (0), Device Brand (1), Sub Region (2), Cluster (3), Team lead (5), ES POC (6)
                        const siteId = row[0] || '';
                        const deviceBrand = row[1] || '';
                        const subRegion = row[2] || '';
                        const cluster = row[3] || '';
                        const teamLead = row[5] || '';
                        const esPOC = row[6] || '';
                        
                        tableHTML += `
                            <tr>
                                <td>${siteId}</td>
                                <td>${deviceBrand}</td>
                                <td>${subRegion}</td>
                                <td>${cluster}</td>
                                <td>${teamLead}</td>
                                <td>${esPOC}</td>
                            </tr>
                        `;
                    });
                } else {
                    tableHTML += `<tr><td colspan="6">No installations found for brand: ${brandName} in cluster: ${clusterName}</td></tr>`;
                }
                
                tableHTML += `
                        </tbody>
                    </table>
                `;
                
                modalContent.innerHTML = tableHTML;
                modal.style.display = 'block';
                console.log('Modal displayed with content');
            } catch (error) {
                console.error('Error in showClusterBrandDetails:', error);
                showStatus('âŒ Error displaying cluster brand details: ' + error.message, 'error');
            }
        }

        // Show sub-region brand details in modal
        function showSubRegionBrandDetails(brandName, subRegionName) {
            try {
                console.log('showSubRegionBrandDetails called with brand:', brandName, 'sub-region:', subRegionName);
                
                // Validate inputs
                if (!brandName || typeof brandName !== 'string' || !subRegionName || typeof subRegionName !== 'string') {
                    console.error('Invalid brand or sub-region name provided:', brandName, subRegionName);
                    return;
                }
                
                const modal = document.getElementById('brandModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalContent = document.getElementById('modalContent');
                
                if (!modal || !modalTitle || !modalContent) {
                    console.error('Modal elements not found');
                    showStatus('âŒ Error: Modal elements not found', 'error');
                    return;
                }
                
                // Check if rawData is available
                if (!rawData || !Array.isArray(rawData)) {
                    console.error('Raw data not available');
                    modalTitle.textContent = `Installations for Brand: ${brandName} in Sub Region: ${subRegionName}`;
                    modalContent.innerHTML = '<p>Error: Data not available</p>';
                    modal.style.display = 'block';
                    return;
                }
                
                modalTitle.textContent = `Installations for Brand: ${brandName} in Sub Region: ${subRegionName}`;
                
                // Find all entries for this brand in this sub-region
                const brandEntries = [];
                for (let i = 1; i < rawData.length; i++) {
                    const row = rawData[i];
                    if (row && Array.isArray(row) && row.length > 4 && 
                        String(row[1]).trim().toLowerCase() === brandName.trim().toLowerCase() && 
                        String(row[2]).trim().toLowerCase() === subRegionName.trim().toLowerCase()) { // Column C for sub-region
                        brandEntries.push(row);
                    }
                }
                
                console.log('Found', brandEntries.length, 'entries for brand:', brandName, 'in sub-region:', subRegionName);
                
                // Create table with specified columns only
                let tableHTML = `
                    <p><strong>Total Installations:</strong> ${brandEntries.length}</p>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Site Id</th>
                                <th>Device Brand</th>
                                <th>Sub Region</th>
                                <th>Cluster</th>
                                <th>Team lead</th>
                                <th>ES POC</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // Add data rows with only specified columns
                if (brandEntries.length > 0) {
                    brandEntries.forEach((row, index) => {
                        console.log('Processing row', index, ':', row);
                        // Map the columns: Site Id (0), Device Brand (1), Sub Region (2), Cluster (3), Team lead (5), ES POC (6)
                        const siteId = row[0] || '';
                        const deviceBrand = row[1] || '';
                        const subRegion = row[2] || '';
                        const cluster = row[3] || '';
                        const teamLead = row[5] || '';
                        const esPOC = row[6] || '';
                        
                        tableHTML += `
                            <tr>
                                <td>${siteId}</td>
                                <td>${deviceBrand}</td>
                                <td>${subRegion}</td>
                                <td>${cluster}</td>
                                <td>${teamLead}</td>
                                <td>${esPOC}</td>
                            </tr>
                        `;
                    });
                } else {
                    tableHTML += `<tr><td colspan="6">No installations found for brand: ${brandName} in sub-region: ${subRegionName}</td></tr>`;
                }
                
                tableHTML += `
                        </tbody>
                    </table>
                `;
                
                modalContent.innerHTML = tableHTML;
                modal.style.display = 'block';
                console.log('Modal displayed with content');
            } catch (error) {
                console.error('Error in showSubRegionBrandDetails:', error);
                showStatus('âŒ Error displaying sub-region brand details: ' + error.message, 'error');
            }
        }

        // Show all brands
        function showAllBrands() {
            try {
                console.log('showAllBrands called');
                
                // Check if brandData is available
                if (!brandData || typeof brandData !== 'object') {
                    console.error('Brand data not available');
                    showStatus('âŒ Error: Brand data not available', 'error');
                    return;
                }
                
                const allBrands = Object.keys(brandData).sort((a, b) => brandData[b] - brandData[a]);
                let content = '<h3>All RMS Brands</h3><ul>';
                
                if (allBrands.length > 0) {
                    allBrands.forEach(brand => {
                        content += `<li><strong>${brand}</strong>: ${brandData[brand]} installations</li>`;
                    });
                } else {
                    content += '<li>No brands found</li>';
                }
                
                content += '</ul>';
                
                const modal = document.getElementById('brandModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalContent = document.getElementById('modalContent');
                
                if (modal && modalTitle && modalContent) {
                    modalTitle.textContent = 'All RMS Brands';
                    modalContent.innerHTML = content;
                    modal.style.display = 'block';
                    console.log('Modal displayed with all brands');
                } else {
                    console.error('Modal elements not found');
                    showStatus('âŒ Error: Modal elements not found', 'error');
                }
            } catch (error) {
                console.error('Error in showAllBrands:', error);
                showStatus('âŒ Error displaying all brands: ' + error.message, 'error');
            }
        }

        // Show all installations
        function showAllInstallations() {
            try {
                console.log('showAllInstallations called');
                
                // Check if rawData is available
                if (!rawData || !Array.isArray(rawData)) {
                    console.error('Raw data not available');
                    showStatus('âŒ Error: Data not available', 'error');
                    return;
                }
                
                // Create table with specified columns only
                let tableHTML = `
                    <h3>All RMS Installations</h3>
                    <p><strong>Total Installations:</strong> ${rawData.length > 0 ? rawData.length - 1 : 0}</p>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Site Id</th>
                                <th>Device Brand</th>
                                <th>Sub Region</th>
                                <th>Cluster</th>
                                <th>Team lead</th>
                                <th>ES POC</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // Add data rows with only specified columns (skip header row)
                let rowCount = 0;
                if (rawData.length > 1) {
                    for (let i = 1; i < rawData.length; i++) {
                        const row = rawData[i];
                        if (row && Array.isArray(row)) {
                            console.log('Processing row', i, ':', row);
                            // Map the columns: Site Id (0), Device Brand (1), Sub Region (2), Cluster (3), Team lead (5), ES POC (6)
                            const siteId = row[0] || '';
                            const deviceBrand = row[1] || '';
                            const subRegion = row[2] || '';
                            const cluster = row[3] || '';
                            const teamLead = row[5] || '';
                            const esPOC = row[6] || '';
                            
                            tableHTML += `
                                <tr>
                                    <td>${siteId}</td>
                                    <td>${deviceBrand}</td>
                                    <td>${subRegion}</td>
                                    <td>${cluster}</td>
                                    <td>${teamLead}</td>
                                    <td>${esPOC}</td>
                                </tr>
                            `;
                            rowCount++;
                        }
                    }
                }
                
                // If no data rows were processed, show a message
                if (rowCount === 0) {
                    tableHTML += `<tr><td colspan="6">No installation data found</td></tr>`;
                }
                
                tableHTML += `
                        </tbody>
                    </table>
                `;
                
                const modal = document.getElementById('brandModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalContent = document.getElementById('modalContent');
                
                if (modal && modalTitle && modalContent) {
                    modalTitle.textContent = 'All RMS Installations';
                    modalContent.innerHTML = tableHTML;
                    modal.style.display = 'block';
                    console.log('Modal displayed with all installations');
                } else {
                    console.error('Modal elements not found');
                    showStatus('âŒ Error: Modal elements not found', 'error');
                }
            } catch (error) {
                console.error('Error in showAllInstallations:', error);
                showStatus('âŒ Error displaying all installations: ' + error.message, 'error');
            }
        }

        // Show top brands
        function showTopBrands() {
            try {
                console.log('showTopBrands called');
                
                // Check if brandData is available
                if (!brandData || typeof brandData !== 'object') {
                    console.error('Brand data not available');
                    showStatus('âŒ Error: Brand data not available', 'error');
                    return;
                }
                
                const topBrands = Object.entries(brandData)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                let content = '<h3>Top 10 RMS Brands</h3><ol>';
                
                if (topBrands.length > 0) {
                    topBrands.forEach(([brand, count]) => {
                        content += `<li><strong>${brand}</strong>: ${count} installations</li>`;
                    });
                } else {
                    content += '<li>No brands found</li>';
                }
                
                content += '</ol>';
                
                const modal = document.getElementById('brandModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalContent = document.getElementById('modalContent');
                
                if (modal && modalTitle && modalContent) {
                    modalTitle.textContent = 'Top 10 RMS Brands';
                    modalContent.innerHTML = content;
                    modal.style.display = 'block';
                    console.log('Modal displayed with top brands');
                } else {
                    console.error('Modal elements not found');
                    showStatus('âŒ Error: Modal elements not found', 'error');
                }
            } catch (error) {
                console.error('Error in showTopBrands:', error);
                showStatus('âŒ Error displaying top brands: ' + error.message, 'error');
            }
        }

        // Close modal when clicking on X
        document.addEventListener('DOMContentLoaded', function() {
            const closeBtn = document.querySelector('.close');
            const modal = document.getElementById('brandModal');
            
            if (closeBtn && modal) {
                closeBtn.onclick = function() {
                    modal.style.display = 'none';
                };
            }
            
            // Close modal when clicking outside of it
            if (modal) {
                window.onclick = function(event) {
                    if (event.target == modal) {
                        modal.style.display = 'none';
                    }
                };
            }
        });

        // Add debugging to help identify issues
        console.log('Modal event handlers initialized');

        // Visit counter functionality
        function updateVisitCounter() {
            // Get current visit count from localStorage
            let visitCount = localStorage.getItem('visitCount') || 0;
            visitCount = parseInt(visitCount) + 1;
            
            // Save updated count
            localStorage.setItem('visitCount', visitCount);
            
            // Update display
            document.getElementById('visitCount').textContent = visitCount;
        }
        
        // Function to open visit history
        function openVisitHistory() {
            alert('Visit history feature coming soon!');
        }
        
        // Initialize visit counter on page load
        window.addEventListener('load', function() {
            updateVisitCounter();
        });

    </script>
</body>
</html>