<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPD Data Details</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            min-height: 100vh;
            color: #333;
            padding: 20px;
            overflow: auto;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            max-width: 100%;
            height: 100vh;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow: visible;
        }

        /* Floating back button */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            animation: floating 3s ease-in-out infinite;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-5px);
        }

        .back-button i {
            font-size: 24px;
            color: #333;
        }

        /* Fixed header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px 40px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: float 6s ease-in-out infinite;
            border: 1px solid rgba(255, 255, 255, 0.3);
            overflow: hidden;
            flex-shrink: 0;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 70%);
            transform: rotate(30deg);
            animation: shine 8s infinite linear;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }

        @keyframes shine {
            0% { transform: rotate(30deg) translateX(-100%); }
            100% { transform: rotate(30deg) translateX(100%); }
        }

        .header .header-content {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .header h1 {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 2rem;
            margin-bottom: 10px;
            color: #333;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-weight: 800;
            letter-spacing: 1px;
        }

        .header p {
            text-align: center;
            color: #666;
            margin: 5px 0 0 0;
            font-size: 14px;
            font-weight: 500;
        }

        .filter-section {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-align: center;
            flex-shrink: 0;
        }

        .filter-section h2 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .filter-info {
            font-size: 1rem;
            margin-bottom: 10px;
            color: #555;
            font-weight: 600;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            flex-shrink: 0;
        }

        /* More colorful cards with distinct backgrounds */
        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            min-height: 120px;
            transform: perspective(1000px) rotateX(0deg);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            animation: floating 3s ease-in-out infinite;
        }

        /* More colorful cards with distinct backgrounds */
        .stat-card:nth-child(1) { 
            background: linear-gradient(135deg, #FF9A8B 0%, #FF6A88 50%, #FF99AC 100%); 
            color: white;
            animation-delay: 0s; 
        }
        .stat-card:nth-child(2) { 
            background: linear-gradient(135deg, #43CBFF 0%, #9708CC 50%, #43CBFF 100%); 
            color: white;
            animation-delay: 0.3s; 
        }
        .stat-card:nth-child(3) { 
            background: linear-gradient(135deg, #5EFCE8 0%, #736EFE 50%, #5EFCE8 100%); 
            color: white;
            animation-delay: 0.6s; 
        }

        .stat-card:hover {
            transform: perspective(1000px) translateY(-15px) scale(1.05);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 255, 255, 0.3);
            letter-spacing: 2px;
            animation: pulse 1.5s infinite;
            /* Add 7-segment display effect */
            background: linear-gradient(to bottom, rgba(255,255,255,0.1), rgba(0,0,0,0.2));
            padding: 5px 10px;
            border-radius: 5px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3), 0 0 5px rgba(255,255,255,0.2);
            /* Ensure the numbers are clearly visible */
            line-height: 1.2;
            /* Add subtle glow effect */
            filter: drop-shadow(0 0 5px rgba(255,255,255,0.5));
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
            100% { transform: scale(1); opacity: 1; }
        }

        .stat-label {
            font-size: 1.1rem;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .data-table-container {
            background: rgba(255, 255, 255, 0.9);
            padding: 35px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            margin-bottom: 35px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            overflow: visible;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9rem;
            flex: 1;
            overflow: visible;
            table-layout: fixed;
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            font-size: 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .data-table tr:nth-child(even) {
            background-color: rgba(245, 245, 245, 0.7);
        }

        .data-table tr:hover {
            background-color: rgba(230, 230, 255, 0.7);
        }

        /* Make specific columns narrower */
        .data-table th:nth-child(1),
        .data-table td:nth-child(1) { width: 8%; } /* Site Id */
        .data-table th:nth-child(2),
        .data-table td:nth-child(2) { width: 10%; } /* Sub Region */
        .data-table th:nth-child(3),
        .data-table td:nth-child(3) { width: 10%; } /* Region */
        .data-table th:nth-child(4),
        .data-table td:nth-child(4) { width: 12%; } /* Beginning */
        .data-table th:nth-child(5),
        .data-table td:nth-child(5) { width: 8%; } /* Days Passed */
        .data-table th:nth-child(6),
        .data-table td:nth-child(6) { width: 12%; } /* Aging */
        .data-table th:nth-child(7),
        .data-table td:nth-child(7) { width: 15%; } /* ES POC */
        .data-table th:nth-child(8),
        .data-table td:nth-child(8) { width: 25%; } /* History | Issue */

        .no-data {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #666;
        }

        /* Floating animation */
        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .data-table-container {
                padding: 20px;
            }
            
            .data-table {
                font-size: 0.9rem;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px 10px;
            }
        }

        .debug-info {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Floating back button -->
        <div class="back-button" onclick="window.location.href='spd_dashboard.html'" title="Back to Dashboard">
            <i class="fas fa-arrow-left"></i>
        </div>

        <div class="header">
            <div class="header-content">
                <h1>SPD Data Details</h1>
                <p>Detailed SPD Alarm Information</p>
            </div>
        </div>

        <div class="filter-section">
            <h2 id="filterTitle">Filtered Data</h2>
            <div class="filter-info" id="filterInfo">Showing all SPD alarms</div>
        </div>

        <div class="debug-info" id="debugInfo" style="display: none;"></div>

        <div class="summary-stats" id="summaryStats">
            <!-- Summary stats will be populated here -->
        </div>

        <div class="data-table-container">
            <table class="data-table" id="dataTable">
                <thead>
                    <tr>
                        <th>Site Id</th>
                        <th>Sub Region</th>
                        <th>Region</th>
                        <th>Beginning</th>
                        <th>Days Passed</th>
                        <th>Aging</th>
                        <th>ES POC</th>
                        <th>History | Issue</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Data will be populated here -->
                </tbody>
            </table>
            <div id="noDataMessage" class="no-data" style="display: none;">
                No data found matching the filter criteria.
            </div>
        </div>
    </div>

    <script>
        // Get URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(window.location.href);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Simple function to add debug info
        function addDebugInfo(message) {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.style.display = 'block';
            debugInfo.innerHTML += message + '<br>';
            debugInfo.scrollTop = debugInfo.scrollHeight;
            console.log(message);
        }

        // Filter data based on criteria
        function filterData(data, filterType) {
            addDebugInfo('Starting filterData with filterType: ' + filterType);
            addDebugInfo('Total data rows: ' + data.length);
            
            const startIndex = data.length > 0 && typeof data[0][0] === 'string' && data[0][0].toLowerCase().includes('site') ? 1 : 0;
            let filteredData = [];
            
            addDebugInfo('Start index: ' + startIndex);
            
            // Count different types for debugging
            let spdCount = 0;
            let enfraCount = 0;
            let smsldCount = 0;
            let resolvedCount = 0;
            let otherCount = 0;
            
            for (let i = startIndex; i < data.length; i++) {
                const row = data[i];
                const columnG = row[6] || ''; // Column G (7th column)
                const columnL = row[11] || ''; // Column L (12th column)
                
                // Count different types
                if (typeof columnG === 'string' && columnG.trim().toUpperCase() === 'SPD') {
                    spdCount++;
                }
                if (typeof columnL === 'string' && columnL.trim().toUpperCase() === 'ENFRA') {
                    enfraCount++;
                }
                if (typeof columnL === 'string' && columnL.trim().toUpperCase() === 'SMS LD') {
                    smsldCount++;
                }
                if (typeof columnL === 'string' && columnL.trim().toUpperCase() === 'RESOLVED') {
                    resolvedCount++;
                }
                const trimmedColumnL = typeof columnL === 'string' ? columnL.trim().toUpperCase() : '';
                if (trimmedColumnL && trimmedColumnL !== '' && 
                    trimmedColumnL !== 'SPD' && 
                    trimmedColumnL !== 'ENFRA' && 
                    trimmedColumnL !== 'SMS LD' && 
                    trimmedColumnL !== 'RESOLVED') {
                    otherCount++;
                }
                
                // Show first 5 rows for debugging (increased from 3)
                if (i < startIndex + 5) {
                    addDebugInfo(`Row ${i}: Column G="${columnG}", Column L="${columnL}"`);
                }
                
                switch(filterType) {
                    case 'spd':
                        if (typeof columnG === 'string' && columnG.trim().toUpperCase() === 'SPD') {
                            filteredData.push(row);
                            if (i < startIndex + 5) addDebugInfo(`Row ${i}: Added SPD alarm`);
                        }
                        break;
                    case 'enfra':
                        if (typeof columnL === 'string' && columnL.trim().toUpperCase() === 'ENFRA') {
                            filteredData.push(row);
                            if (i < startIndex + 5) addDebugInfo(`Row ${i}: Added Enfra alarm`);
                        }
                        break;
                    case 'smsld':
                        if (typeof columnL === 'string' && columnL.trim().toUpperCase() === 'SMS LD') {
                            filteredData.push(row);
                            if (i < startIndex + 5) addDebugInfo(`Row ${i}: Added SMS LD alarm`);
                        }
                        break;
                    case 'resolved':
                        if (typeof columnL === 'string' && columnL.trim().toUpperCase() === 'RESOLVED') {
                            filteredData.push(row);
                            if (i < startIndex + 5) addDebugInfo(`Row ${i}: Added Resolved alarm`);
                        }
                        break;
                    case 'others':
                        // Show all non-empty values in Column L that are not the specific types
                        const trimmedColumnL = typeof columnL === 'string' ? columnL.trim().toUpperCase() : '';
                        if (trimmedColumnL && trimmedColumnL !== '' && 
                            trimmedColumnL !== 'SPD' && 
                            trimmedColumnL !== 'ENFRA' && 
                            trimmedColumnL !== 'SMS LD' && 
                            trimmedColumnL !== 'RESOLVED') {
                            filteredData.push(row);
                            if (i < startIndex + 5) addDebugInfo(`Row ${i}: Added Other alarm`);
                        }
                        break;
                    default:
                        // For 'all' or other filters, exclude Enfra alarms
                        if (!(typeof columnL === 'string' && columnL.trim().toUpperCase() === 'ENFRA')) {
                            filteredData.push(row);
                            if (i < startIndex + 5) addDebugInfo(`Row ${i}: Added to default filter`);
                        }
                }
            }
            
            addDebugInfo('Counts - SPD: ' + spdCount + ', Enfra: ' + enfraCount + ', SMS LD: ' + smsldCount + ', Resolved: ' + resolvedCount + ', Others: ' + otherCount);
            addDebugInfo('Filtered data count: ' + filteredData.length);
            
            // Show first 5 filtered rows for debugging
            if (filteredData.length > 0) {
                addDebugInfo('First 5 filtered rows:');
                for (let i = 0; i < Math.min(5, filteredData.length); i++) {
                    addDebugInfo('Filtered Row ' + i + ': ' + JSON.stringify(filteredData[i]));
                }
            }
            
            return filteredData;
        }

        // Display data in table
        function displayData(data, filterType) {
            addDebugInfo('Displaying data for filterType: ' + filterType);
            addDebugInfo('Data length: ' + data.length);
            
            const tableBody = document.getElementById('tableBody');
            const noDataMessage = document.getElementById('noDataMessage');
            const filterTitle = document.getElementById('filterTitle');
            const filterInfo = document.getElementById('filterInfo');
            
            // Set filter title and info
            switch(filterType) {
                case 'spd':
                    filterTitle.textContent = 'SPD Alarms';
                    filterInfo.textContent = 'Showing all SPD alarms (Column G = "SPD") - Total: ' + data.length;
                    break;
                case 'enfra':
                    filterTitle.textContent = 'Enfra Alarms';
                    filterInfo.textContent = 'Showing all Enfra alarms (Column L = "Enfra") - Total: ' + data.length;
                    break;
                case 'smsld':
                    filterTitle.textContent = 'SMS LD Alarms';
                    filterInfo.textContent = 'Showing all SMS LD alarms (Column L = "SMS LD") - Total: ' + data.length;
                    break;
                case 'resolved':
                    filterTitle.textContent = 'Resolved Alarms';
                    filterInfo.textContent = 'Showing all Resolved alarms (Column L = "Resolved") - Total: ' + data.length;
                    break;
                case 'others':
                    filterTitle.textContent = 'Other Alarms';
                    filterInfo.textContent = 'Showing all Other alarms (Column L = Other values) - Total: ' + data.length;
                    break;
                default:
                    // Hide the filter section completely for default case
                    document.querySelector('.filter-section').style.display = 'none';
            }
            
            // Always show the filter section for specific filters
            if (['spd', 'enfra', 'smsld', 'resolved', 'others'].includes(filterType)) {
                document.querySelector('.filter-section').style.display = 'block';
            }
            
            if (data.length === 0) {
                tableBody.innerHTML = '';
                noDataMessage.style.display = 'block';
                noDataMessage.textContent = 'No data found matching the filter criteria.';
                return;
            }
            
            noDataMessage.style.display = 'none';
            
            // Clear existing data
            tableBody.innerHTML = '';
            
            // Add rows with correct column mapping as specified
            data.forEach((row, index) => {
                // Show first 5 rows for debugging
                if (index < 5) {
                    addDebugInfo('Displaying row ' + index + ': ' + JSON.stringify(row));
                }
                
                const tr = document.createElement('tr');
                
                // Site Id (Column A - index 0)
                const td1 = document.createElement('td');
                td1.textContent = row[0] || '';
                tr.appendChild(td1);
                
                // Sub Region (Column B - index 1)
                const td2 = document.createElement('td');
                td2.textContent = row[1] || '';
                tr.appendChild(td2);
                
                // Region (Column C - index 2)
                const td3 = document.createElement('td');
                td3.textContent = row[2] || '';
                tr.appendChild(td3);
                
                // Beginning (Column D - index 3) - Format as DD-MMM-YY
                const td4 = document.createElement('td');
                let dateValue = row[3] || '';
                if (dateValue) {
                    // Try to format as DD-MMM-YY
                    try {
                        if (typeof dateValue === 'number') {
                            // Excel date serial number
                            const date = new Date((dateValue - 25569) * 86400 * 1000);
                            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                            const day = date.getUTCDate();
                            const month = months[date.getUTCMonth()];
                            const year = date.getUTCFullYear().toString().substr(-2);
                            dateValue = `${day.toString().padStart(2, '0')}-${month}-${year}`;
                        } else if (typeof dateValue === 'string' && !isNaN(dateValue)) {
                            // String number
                            const numValue = parseFloat(dateValue);
                            const date = new Date((numValue - 25569) * 86400 * 1000);
                            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                            const day = date.getUTCDate();
                            const month = months[date.getUTCMonth()];
                            const year = date.getUTCFullYear().toString().substr(-2);
                            dateValue = `${day.toString().padStart(2, '0')}-${month}-${year}`;
                        }
                        // If it's already a formatted date string, keep as is
                    } catch (e) {
                        // Keep original value if formatting fails
                    }
                }
                td4.textContent = dateValue;
                tr.appendChild(td4);
                
                // Days Passed (Column E - index 4) - Format as integer (zero decimal places)
                const td5 = document.createElement('td');
                let daysValue = row[4] || '';
                if (daysValue) {
                    try {
                        if (typeof daysValue === 'number') {
                            daysValue = Math.round(daysValue); // Round to zero decimal places
                        } else if (typeof daysValue === 'string' && !isNaN(daysValue)) {
                            daysValue = Math.round(parseFloat(daysValue)); // Round to zero decimal places
                        }
                    } catch (e) {
                        // Keep original value if conversion fails
                    }
                }
                td5.textContent = daysValue;
                tr.appendChild(td5);
                
                // Aging (Column F - index 5)
                const td6 = document.createElement('td');
                td6.textContent = row[5] || '';
                tr.appendChild(td6);
                
                // ES POC (Column H - index 7)
                const td7 = document.createElement('td');
                td7.textContent = row[7] || '';
                tr.appendChild(td7);
                
                // History | Issue (Column J - index 9)
                const td8 = document.createElement('td');
                td8.textContent = row[9] || '';
                tr.appendChild(td8);
                
                tableBody.appendChild(tr);
            });
            
            // Display summary stats
            displaySummaryStats(data, filterType);
        }

        // Display summary statistics
        function displaySummaryStats(data, filterType) {
            const summaryStats = document.getElementById('summaryStats');
            
            // Count aging categories (Column F - index 5)
            const agingCounts = {};
            // Count domains/reasons (Column J - index 9)
            const domainCounts = {};
            
            data.forEach(row => {
                // Column F (Aging)
                const aging = row[5] || '';
                if (aging) {
                    agingCounts[aging] = (agingCounts[aging] || 0) + 1;
                }
                
                // Column J (History | Issue)
                const historyIssue = row[9] || '';
                if (historyIssue) {
                    domainCounts[historyIssue] = (domainCounts[historyIssue] || 0) + 1;
                }
            });
            
            // Get top 3 aging categories
            const sortedAging = Object.entries(agingCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3);
            
            // Get top 3 history/issue categories
            const sortedDomains = Object.entries(domainCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3);
            
            // Create summary cards
            let agingText = 'N/A';
            let agingCount = 0;
            if (sortedAging.length > 0) {
                agingText = sortedAging[0][0];
                agingCount = sortedAging[0][1];
            }
            
            let domainText = 'N/A';
            let domainCount = 0;
            if (sortedDomains.length > 0) {
                domainText = sortedDomains[0][0];
                domainCount = sortedDomains[0][1];
            }
            
            summaryStats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${data.length}</div>
                    <div class="stat-label">Total Alarms</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${agingCount}</div>
                    <div class="stat-label">Most Common Aging: ${agingText}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${domainCount}</div>
                    <div class="stat-label">Top History/Issue: ${domainText}</div>
                </div>
            `;
        }

        // Load SPD data directly from SPD.xlsx
        function loadSPDDataDirectly(filterType) {
            addDebugInfo('Loading SPD data directly from SPD.xlsx');
            fetch('SPD.xlsx')
                .then(response => {
                    addDebugInfo('Fetch response status: ' + response.status);
                    if (!response.ok) {
                        throw new Error('Network response was not ok: ' + response.status);
                    }
                    return response.arrayBuffer();
                })
                .then(data => {
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    addDebugInfo('SPD.xlsx loaded successfully, rows: ' + jsonData.length);
                    
                    // Show first 3 rows
                    addDebugInfo('First 3 rows: ' + JSON.stringify(jsonData.slice(0, 3)));
                    
                    const filteredData = filterData(jsonData, filterType);
                    displayData(filteredData, filterType);
                })
                .catch(error => {
                    addDebugInfo('Error loading SPD.xlsx: ' + error.message);
                    document.getElementById('noDataMessage').textContent = 'Error loading data: ' + error.message;
                    document.getElementById('noDataMessage').style.display = 'block';
                });
        }

        // Load and process data
        window.addEventListener('load', function() {
            const filterType = getUrlParameter('filter') || 'all';
            addDebugInfo('Page loaded with filterType: ' + filterType);
            
            // Try to load data from localStorage first (passed from dashboard)
            try {
                const storedData = localStorage.getItem('spdData');
                if (storedData) {
                    const data = JSON.parse(storedData);
                    addDebugInfo('Data loaded from localStorage, rows: ' + data.length);
                    addDebugInfo('First 3 rows: ' + JSON.stringify(data.slice(0, 3)));
                    
                    const filteredData = filterData(data, filterType);
                    displayData(filteredData, filterType);
                    return;
                } else {
                    addDebugInfo('No data found in localStorage');
                }
            } catch (e) {
                addDebugInfo('Error parsing stored data from localStorage: ' + e.message);
            }
            
            // Always load directly from SPD.xlsx for SPD filter to ensure accuracy
            if (filterType === 'spd') {
                loadSPDDataDirectly(filterType);
                return;
            }
            
            // If no stored data, try to load from SPD.xlsx
            addDebugInfo('Loading data from SPD.xlsx file');
            fetch('SPD.xlsx')
                .then(response => {
                    addDebugInfo('Fetch response status: ' + response.status);
                    if (!response.ok) {
                        throw new Error('Network response was not ok: ' + response.status);
                    }
                    return response.arrayBuffer();
                })
                .then(data => {
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    addDebugInfo('SPD.xlsx loaded successfully, rows: ' + jsonData.length);
                    addDebugInfo('First 3 rows: ' + JSON.stringify(jsonData.slice(0, 3)));
                    const filteredData = filterData(jsonData, filterType);
                    displayData(filteredData, filterType);
                })
                .catch(error => {
                    addDebugInfo('Error loading SPD.xlsx: ' + error.message);
                    document.getElementById('noDataMessage').textContent = 'Error loading data: ' + error.message;
                    document.getElementById('noDataMessage').style.display = 'block';
                });
        });

    </script>
</body>
</html>