<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DC CTs & SPD Database - RMS Dashboard</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
            padding: 10px;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            display: flex;
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
            gap: 15px;
        }

        /* Navigation sidebar */
        .nav-sidebar {
            width: 180px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            height: fit-content;
        }

        .nav-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            width: 100%;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-button i {
            width: 20px;
            text-align: center;
        }

        .nav-button.active {
            background: rgba(0, 195, 255, 0.3);
            border: 1px solid #00c3ff;
        }

        .nav-button:hover:not(.active) {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Equipment type selector */
        .equipment-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .equipment-button {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .equipment-button.active {
            background: rgba(0, 195, 255, 0.3);
            border: 1px solid #00c3ff;
        }

        /* Main content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Back button */
        .back-button {
            position: fixed;
            top: 15px;
            left: 15px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-3px);
        }

        .back-button i {
            font-size: 20px;
            color: #fff;
        }

        /* Header - smaller size */
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            color: white;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
        }

        /* Status indicator */
        .status-indicator {
            display: inline-block;
            background: rgba(0, 195, 255, 0.2);
            color: #00c3ff;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: bold;
            border: 1px solid #00c3ff;
            margin-top: 10px;
        }

        /* Form section */
        .form-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
        }

        .form-section.active {
            display: block;
        }

        .form-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: white;
            text-align: center;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: bold;
            font-size: 1rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.2);
            color: white;
            font-size: 1rem;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #00c3ff;
        }

        .submit-button {
            background: linear-gradient(135deg, #00c9ff, #92fe9d);
            color: #333;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 15px auto 0;
        }

        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* Stats section */
        .stats-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
        }

        .stats-section.active {
            display: block;
        }

        .stats-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: white;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: #00c3ff;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .chart-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }

        .chart-title {
            font-size: 1.1rem;
            margin-bottom: 12px;
            color: white;
        }

        .chart-wrapper {
            position: relative;
            height: 250px;
        }

        /* Data table section */
        .data-table-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
            overflow-x: auto;
        }

        .data-table-container.active {
            display: block;
        }

        .table-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: white;
            text-align: center;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: rgba(26, 42, 108, 0.7);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }

        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .action-button {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px 25px;
            color: white;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .action-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .action-button.primary {
            background: linear-gradient(135deg, #00c9ff, #92fe9d);
            color: #333;
        }

        .action-button.secondary {
            background: linear-gradient(135deg, #ff8a00, #da1b60);
            color: white;
        }

        /* Responsive design */
        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
            }
            
            .nav-sidebar {
                width: 100%;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .container {
                padding: 5px;
            }
            
            .nav-sidebar {
                padding: 10px 5px;
            }
            
            .nav-button {
                padding: 10px 12px;
                font-size: 0.8rem;
            }
            
            .header {
                padding: 12px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .header p {
                font-size: 0.9rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .equipment-selector {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .back-button {
                width: 45px;
                height: 45px;
                top: 10px;
                left: 10px;
            }
            
            .header {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.3rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px 6px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Back button -->
        <div class="back-button" onclick="window.location.href='tasks_activities.html'" title="Back to Tasks & Activities">
            <i class="fas fa-arrow-left"></i>
        </div>

        <!-- Navigation sidebar with buttons -->
        <div class="nav-sidebar">
            <div class="nav-button active" onclick="showTab('receiving')">
                <i class="fas fa-download"></i>
                <span>Receiving Entry</span>
            </div>
            <div class="nav-button" onclick="showTab('usage')">
                <i class="fas fa-upload"></i>
                <span>Usage Entry</span>
            </div>
            <div class="nav-button" onclick="showTab('stats')">
                <i class="fas fa-chart-bar"></i>
                <span>Stats</span>
            </div>
            <div class="nav-button" onclick="showTab('data')">
                <i class="fas fa-database"></i>
                <span>Data Records</span>
            </div>
            <div class="nav-button" onclick="setEquipmentType('dc_cts')">
                <i class="fas fa-microchip"></i>
                <span>DC CTs</span>
            </div>
            <div class="nav-button" onclick="setEquipmentType('spd')">
                <i class="fas fa-shield-alt"></i>
                <span>SPD</span>
            </div>
        </div>

        <!-- Main content -->
        <div class="main-content">
            <!-- Header - smaller size -->
            <div class="header">
                <h1><i class="fas fa-microchip"></i> DC CTs & SPD Database</h1>
                <p>Track DC Current Transformers & Surge Protection Devices - Receiving and Usage</p>
                <div class="status-indicator">In Progress</div>
            </div>

            <!-- Receiving Entry Form -->
            <div id="receiving-tab" class="form-section active">
                <h2 class="form-title">Receiving Entry - <span id="equipment-type-display">DC CTs</span></h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="receiving-date"><i class="fas fa-calendar"></i> Date</label>
                        <input type="date" id="receiving-date" required>
                    </div>
                    <div class="form-group">
                        <label for="material-name"><i class="fas fa-box"></i> Material Name</label>
                        <input type="text" id="material-name" placeholder="Enter material name" required>
                    </div>
                    <div class="form-group">
                        <label for="quantity"><i class="fas fa-sort-numeric-up"></i> Quantity</label>
                        <input type="number" id="quantity" placeholder="Enter quantity" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="invoice-no"><i class="fas fa-file-invoice"></i> Invoice Number</label>
                        <input type="text" id="invoice-no" placeholder="Enter invoice number">
                    </div>
                    <div class="form-group">
                        <label for="receiving-photos"><i class="fas fa-camera"></i> Photos (Max 5)</label>
                        <input type="file" id="receiving-photos" accept="image/*" multiple>
                        <div id="receiving-photos-preview" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px;">
                            <!-- Photo previews will be added here -->
                        </div>
                    </div>
                </div>
                <button class="submit-button" onclick="saveReceivingEntry()">
                    <i class="fas fa-save"></i> Save Receiving Entry
                </button>
            </div>

            <!-- Usage Entry Form -->
            <div id="usage-tab" class="form-section">
                <h2 class="form-title">Usage Entry - <span id="usage-equipment-type-display">DC CTs</span></h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="usage-date"><i class="fas fa-calendar"></i> Date</label>
                        <input type="date" id="usage-date" required>
                    </div>
                    <div class="form-group">
                        <label for="site-id"><i class="fas fa-map-marker-alt"></i> Site ID</label>
                        <input type="text" id="site-id" placeholder="Enter site ID" required>
                    </div>
                    <div class="form-group">
                        <label for="sub-region"><i class="fas fa-globe"></i> Region</label>
                        <select id="sub-region" required>
                            <option value="">Select Region</option>
                            <option value="Jacob Abad">Jacob Abad</option>
                            <option value="Larkana">Larkana</option>
                            <option value="Sukkur">Sukkur</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="used-quantity"><i class="fas fa-sort-numeric-up"></i> Used Quantity</label>
                        <input type="number" id="used-quantity" placeholder="Enter quantity" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="team-name"><i class="fas fa-users"></i> Team Name</label>
                        <input type="text" id="team-name" placeholder="Enter team name" required>
                    </div>
                    <div class="form-group">
                        <label for="es-poc-name"><i class="fas fa-user"></i> ES POC Name</label>
                        <input type="text" id="es-poc-name" placeholder="Enter ES POC name" required>
                    </div>
                    <div class="form-group">
                        <label for="usage-photos"><i class="fas fa-camera"></i> Photos (Max 5)</label>
                        <input type="file" id="usage-photos" accept="image/*" multiple>
                        <div id="usage-photos-preview" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px;">
                            <!-- Photo previews will be added here -->
                        </div>
                    </div>
                </div>
                <button class="submit-button" onclick="saveUsageEntry()">
                    <i class="fas fa-save"></i> Save Usage Entry
                </button>
            </div>

            <!-- Statistics & Graphs Section -->
            <div id="stats-tab" class="stats-section">
                <h2 class="stats-title">Statistics & Graphs - <span id="stats-equipment-type-display">DC CTs</span></h2>
                
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-received">0</div>
                        <div class="stat-label">Total Received</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-used">0</div>
                        <div class="stat-label">Total Used</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="available-stock">0</div>
                        <div class="stat-label">Available Stock</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="active-sites">0</div>
                        <div class="stat-label">Active Sites</div>
                    </div>
                </div>
                
                <!-- Charts -->
                <div class="charts-container">
                    <div class="chart-container">
                        <div class="chart-title">Receiving Trend</div>
                        <div class="chart-wrapper">
                            <canvas id="receiving-chart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Usage by Region</div>
                        <div class="chart-wrapper">
                            <canvas id="usage-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Records Section -->
            <div id="data-tab" class="data-table-container">
                <h2 class="table-title">Data Records - <span id="data-equipment-type-display">DC CTs</span></h2>
                
                <!-- Receiving Records Table -->
                <h3 style="margin: 15px 0 10px; color: #00c3ff;">Receiving Records</h3>
                <div style="overflow-x: auto;">
                    <table class="data-table" id="receiving-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Material Name</th>
                                <th>Quantity</th>
                                <th>Invoice No</th>
                                <th>Photo</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="receiving-records">
                            <tr>
                                <td colspan="6" style="text-align: center;">No receiving records found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Usage Records Table -->
                <h3 style="margin: 20px 0 10px; color: #00c3ff;">Usage Records</h3>
                <div style="overflow-x: auto;">
                    <table class="data-table" id="usage-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Site ID</th>
                                <th>Region</th>
                                <th>Used Quantity</th>
                                <th>Team Name</th>
                                <th>ES POC Name</th>
                                <th>Photo</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usage-records">
                            <tr>
                                <td colspan="8" style="text-align: center;">No usage records found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <div class="action-button primary" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> Export to Excel
                    </div>
                    <div class="action-button secondary" onclick="clearAllData()">
                        <i class="fas fa-trash"></i> Clear All Data
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize data arrays
        let dcCtsReceivingData = JSON.parse(localStorage.getItem('dcCtsReceivingData')) || [];
        let dcCtsUsageData = JSON.parse(localStorage.getItem('dcCtsUsageData')) || [];
        let spdReceivingData = JSON.parse(localStorage.getItem('spdReceivingData')) || [];
        let spdUsageData = JSON.parse(localStorage.getItem('spdUsageData')) || [];
        
        // Current equipment type
        let currentEquipmentType = 'dc_cts'; // 'dc_cts' or 'spd'
        
        // Initialize charts
        let receivingChart = null;
        let usageChart = null;
        
        // Photo data storage
        let receivingPhotosData = [];
        let usagePhotosData = [];
        
        // Set up photo preview listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Receiving photos preview
            const receivingPhotosInput = document.getElementById('receiving-photos');
            if (receivingPhotosInput) {
                receivingPhotosInput.addEventListener('change', function(e) {
                    receivingPhotosData = [];
                    const previewContainer = document.getElementById('receiving-photos-preview');
                    previewContainer.innerHTML = '';
                    
                    if (e.target.files) {
                        // Limit to 5 photos
                        const files = Array.from(e.target.files).slice(0, 5);
                        
                        files.forEach((file, index) => {
                            const reader = new FileReader();
                            reader.onload = function(event) {
                                receivingPhotosData.push(event.target.result);
                                
                                // Create preview element
                                const previewDiv = document.createElement('div');
                                previewDiv.style.position = 'relative';
                                previewDiv.style.display = 'inline-block';
                                
                                const img = document.createElement('img');
                                img.src = event.target.result;
                                img.alt = `Photo ${index + 1}`;
                                img.style.maxWidth = '100px';
                                img.style.maxHeight = '100px';
                                img.style.borderRadius = '5px';
                                img.style.border = '2px solid #00c3ff';
                                
                                previewDiv.appendChild(img);
                                previewContainer.appendChild(previewDiv);
                            };
                            reader.readAsDataURL(file);
                        });
                    }
                });
            }
            
            // Usage photos preview
            const usagePhotosInput = document.getElementById('usage-photos');
            if (usagePhotosInput) {
                usagePhotosInput.addEventListener('change', function(e) {
                    usagePhotosData = [];
                    const previewContainer = document.getElementById('usage-photos-preview');
                    previewContainer.innerHTML = '';
                    
                    if (e.target.files) {
                        // Limit to 5 photos
                        const files = Array.from(e.target.files).slice(0, 5);
                        
                        files.forEach((file, index) => {
                            const reader = new FileReader();
                            reader.onload = function(event) {
                                usagePhotosData.push(event.target.result);
                                
                                // Create preview element
                                const previewDiv = document.createElement('div');
                                previewDiv.style.position = 'relative';
                                previewDiv.style.display = 'inline-block';
                                
                                const img = document.createElement('img');
                                img.src = event.target.result;
                                img.alt = `Photo ${index + 1}`;
                                img.style.maxWidth = '100px';
                                img.style.maxHeight = '100px';
                                img.style.borderRadius = '5px';
                                img.style.border = '2px solid #00c3ff';
                                
                                previewDiv.appendChild(img);
                                previewContainer.appendChild(previewDiv);
                            };
                            reader.readAsDataURL(file);
                        });
                    }
                });
            }
        });
        
        // Set equipment type
        function setEquipmentType(type) {
            currentEquipmentType = type;
            
            // Update UI for equipment buttons
            document.querySelectorAll('.equipment-button, .nav-button').forEach(button => {
                if ((type === 'dc_cts' && button.textContent.includes('DC CTs')) || 
                    (type === 'spd' && button.textContent.includes('SPD'))) {
                    button.classList.add('active');
                } else if (button.textContent.includes('DC CTs') || button.textContent.includes('SPD')) {
                    button.classList.remove('active');
                }
            });
            
            // Update display text
            document.getElementById('equipment-type-display').textContent = type === 'dc_cts' ? 'DC CTs' : 'SPD';
            document.getElementById('usage-equipment-type-display').textContent = type === 'dc_cts' ? 'DC CTs' : 'SPD';
            document.getElementById('stats-equipment-type-display').textContent = type === 'dc_cts' ? 'DC CTs' : 'SPD';
            document.getElementById('data-equipment-type-display').textContent = type === 'dc_cts' ? 'DC CTs' : 'SPD';
            
            // Update stats and charts if stats tab is active
            if (document.getElementById('stats-tab').classList.contains('active')) {
                updateStats();
                updateCharts();
            }
            
            // Update data tables if data tab is active
            if (document.getElementById('data-tab').classList.contains('active')) {
                updateDataTables();
            }
        }
        
        // Show tab function
        function showTab(tabName) {
            // Hide all sections
            document.querySelectorAll('.form-section, .stats-section, .data-table-container').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-button').forEach(button => {
                if (!button.textContent.includes('DC CTs') && !button.textContent.includes('SPD')) {
                    button.classList.remove('active');
                }
            });
            
            // Show selected section
            if (tabName === 'receiving') {
                document.getElementById('receiving-tab').classList.add('active');
            } else if (tabName === 'usage') {
                document.getElementById('usage-tab').classList.add('active');
            } else if (tabName === 'stats') {
                document.getElementById('stats-tab').classList.add('active');
                updateStats();
                updateCharts();
            } else if (tabName === 'data') {
                document.getElementById('data-tab').classList.add('active');
                updateDataTables();
            }
            
            // Add active class to clicked button
            document.querySelectorAll('.nav-button').forEach(button => {
                if (button.textContent.toLowerCase().includes(tabName)) {
                    button.classList.add('active');
                }
            });
        }
        
        // Get current data arrays based on equipment type
        function getCurrentDataArrays() {
            if (currentEquipmentType === 'dc_cts') {
                return {
                    receiving: dcCtsReceivingData,
                    usage: dcCtsUsageData
                };
            } else {
                return {
                    receiving: spdReceivingData,
                    usage: spdUsageData
                };
            }
        }
        
        // Save receiving entry
        function saveReceivingEntry() {
            const date = document.getElementById('receiving-date').value;
            const materialName = document.getElementById('material-name').value;
            const quantity = document.getElementById('quantity').value;
            const invoiceNo = document.getElementById('invoice-no').value;
            
            if (!date || !materialName || !quantity) {
                alert('Please fill in all required fields');
                return;
            }
            
            const entry = {
                date: date,
                materialName: materialName,
                quantity: parseInt(quantity),
                invoiceNo: invoiceNo,
                equipmentType: currentEquipmentType,
                photos: [...receivingPhotosData] // Store a copy of the photos array
            };
            
            if (currentEquipmentType === 'dc_cts') {
                dcCtsReceivingData.push(entry);
                localStorage.setItem('dcCtsReceivingData', JSON.stringify(dcCtsReceivingData));
            } else {
                spdReceivingData.push(entry);
                localStorage.setItem('spdReceivingData', JSON.stringify(spdReceivingData));
            }
            
            alert('Receiving entry saved successfully!');
            
            // Clear form
            document.getElementById('receiving-date').value = '';
            document.getElementById('material-name').value = '';
            document.getElementById('quantity').value = '';
            document.getElementById('invoice-no').value = '';
            document.getElementById('receiving-photos').value = '';
            document.getElementById('receiving-photos-preview').innerHTML = '';
            receivingPhotosData = [];
            
            // Update stats if stats tab is active
            if (document.getElementById('stats-tab').classList.contains('active')) {
                updateStats();
                updateCharts();
            }
        }
        
        // Save usage entry
        function saveUsageEntry() {
            const date = document.getElementById('usage-date').value;
            const siteId = document.getElementById('site-id').value;
            const subRegion = document.getElementById('sub-region').value;
            const usedQuantity = document.getElementById('used-quantity').value;
            const teamName = document.getElementById('team-name').value;
            const esPocName = document.getElementById('es-poc-name').value;
            
            if (!date || !siteId || !subRegion || !usedQuantity || !teamName || !esPocName) {
                alert('Please fill in all required fields');
                return;
            }
            
            const entry = {
                date: date,
                siteId: siteId,
                subRegion: subRegion,
                usedQuantity: parseInt(usedQuantity),
                teamName: teamName,
                esPocName: esPocName,
                equipmentType: currentEquipmentType,
                photos: [...usagePhotosData] // Store a copy of the photos array
            };
            
            if (currentEquipmentType === 'dc_cts') {
                dcCtsUsageData.push(entry);
                localStorage.setItem('dcCtsUsageData', JSON.stringify(dcCtsUsageData));
            } else {
                spdUsageData.push(entry);
                localStorage.setItem('spdUsageData', JSON.stringify(spdUsageData));
            }
            
            alert('Usage entry saved successfully!');
            
            // Clear form
            document.getElementById('usage-date').value = '';
            document.getElementById('site-id').value = '';
            document.getElementById('sub-region').value = '';
            document.getElementById('used-quantity').value = '';
            document.getElementById('team-name').value = '';
            document.getElementById('es-poc-name').value = '';
            document.getElementById('usage-photos').value = '';
            document.getElementById('usage-photos-preview').innerHTML = '';
            usagePhotosData = [];
            
            // Update stats if stats tab is active
            if (document.getElementById('stats-tab').classList.contains('active')) {
                updateStats();
                updateCharts();
            }
        }
        
        // Update statistics
        function updateStats() {
            const data = getCurrentDataArrays();
            const totalReceived = data.receiving.reduce((sum, item) => sum + item.quantity, 0);
            const totalUsed = data.usage.reduce((sum, item) => sum + item.usedQuantity, 0);
            const availableStock = totalReceived - totalUsed;
            
            // Get unique sites
            const uniqueSites = [...new Set(data.usage.map(item => item.siteId))];
            
            document.getElementById('total-received').textContent = totalReceived;
            document.getElementById('total-used').textContent = totalUsed;
            document.getElementById('available-stock').textContent = availableStock;
            document.getElementById('active-sites').textContent = uniqueSites.length;
        }
        
        // Update charts
        function updateCharts() {
            // Destroy existing charts if they exist
            if (receivingChart) {
                receivingChart.destroy();
            }
            if (usageChart) {
                usageChart.destroy();
            }
            
            const data = getCurrentDataArrays();
            
            // Receiving trend chart
            const receivingCtx = document.getElementById('receiving-chart').getContext('2d');
            
            // Group receiving data by month
            const receivingByMonth = {};
            data.receiving.forEach(item => {
                const date = new Date(item.date);
                const month = date.toLocaleString('default', { month: 'short', year: 'numeric' });
                if (!receivingByMonth[month]) {
                    receivingByMonth[month] = 0;
                }
                receivingByMonth[month] += item.quantity;
            });
            
            const receivingLabels = Object.keys(receivingByMonth);
            const receivingValues = Object.values(receivingByMonth);
            
            receivingChart = new Chart(receivingCtx, {
                type: 'line',
                data: {
                    labels: receivingLabels,
                    datasets: [{
                        label: 'Quantity Received',
                        data: receivingValues,
                        borderColor: '#00c3ff',
                        backgroundColor: 'rgba(0, 195, 255, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#fff'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#fff'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#fff'
                            }
                        }
                    }
                }
            });
            
            // Usage by sub-region chart
            const usageCtx = document.getElementById('usage-chart').getContext('2d');
            
            // Group usage data by sub-region
            const usageByRegion = {};
            data.usage.forEach(item => {
                if (!usageByRegion[item.subRegion]) {
                    usageByRegion[item.subRegion] = 0;
                }
                usageByRegion[item.subRegion] += item.usedQuantity;
            });
            
            const usageLabels = Object.keys(usageByRegion);
            const usageValues = Object.values(usageByRegion);
            
            usageChart = new Chart(usageCtx, {
                type: 'bar',
                data: {
                    labels: usageLabels,
                    datasets: [{
                        label: 'Quantity Used',
                        data: usageValues,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#fff'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#fff'
                            }
                        }
                    }
                }
            });
        }
        
        // Update data tables
        function updateDataTables() {
            const data = getCurrentDataArrays();
            
            // Update receiving table
            const receivingBody = document.getElementById('receiving-records');
            if (data.receiving.length === 0) {
                receivingBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No receiving records found</td></tr>';
            } else {
                receivingBody.innerHTML = '';
                data.receiving.forEach((item, index) => {
                    const photoCount = item.photos ? item.photos.length : 0;
                    let photoPreviews = '';
                    
                    if (item.photos && item.photos.length > 0) {
                        // Show first photo as thumbnail, indicate if there are more
                        photoPreviews = `<img src="${item.photos[0]}" alt="Photo" style="max-width: 50px; max-height: 50px; border-radius: 3px; cursor: pointer;" onclick="showPhotosModal(${index}, 'receiving')">`;
                        if (item.photos.length > 1) {
                            photoPreviews += ` <span style="font-size: 0.8rem; color: #00c3ff;">+${item.photos.length - 1} more</span>`;
                        }
                    } else {
                        photoPreviews = 'No Photos';
                    }
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatDate(item.date)}</td>
                        <td>${item.materialName}</td>
                        <td>${item.quantity}</td>
                        <td>${item.invoiceNo || 'N/A'}</td>
                        <td>${photoPreviews}</td>
                        <td>
                            <button class="action-button" style="padding: 5px 10px; margin: 2px;" onclick="editReceivingEntry(${index})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-button secondary" style="padding: 5px 10px; margin: 2px;" onclick="deleteReceivingEntry(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    receivingBody.appendChild(row);
                });
            }
            
            // Update usage table
            const usageBody = document.getElementById('usage-records');
            if (data.usage.length === 0) {
                usageBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No usage records found</td></tr>';
            } else {
                usageBody.innerHTML = '';
                data.usage.forEach((item, index) => {
                    const photoCount = item.photos ? item.photos.length : 0;
                    let photoPreviews = '';
                    
                    if (item.photos && item.photos.length > 0) {
                        // Show first photo as thumbnail, indicate if there are more
                        photoPreviews = `<img src="${item.photos[0]}" alt="Photo" style="max-width: 50px; max-height: 50px; border-radius: 3px; cursor: pointer;" onclick="showPhotosModal(${index}, 'usage')">`;
                        if (item.photos.length > 1) {
                            photoPreviews += ` <span style="font-size: 0.8rem; color: #00c3ff;">+${item.photos.length - 1} more</span>`;
                        }
                    } else {
                        photoPreviews = 'No Photos';
                    }
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatDate(item.date)}</td>
                        <td>${item.siteId}</td>
                        <td>${item.subRegion}</td>
                        <td>${item.usedQuantity}</td>
                        <td>${item.teamName}</td>
                        <td>${item.esPocName}</td>
                        <td>${photoPreviews}</td>
                        <td>
                            <button class="action-button" style="padding: 5px 10px; margin: 2px;" onclick="editUsageEntry(${index})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-button secondary" style="padding: 5px 10px; margin: 2px;" onclick="deleteUsageEntry(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    usageBody.appendChild(row);
                });
            }
        }
        
        // Show photos in modal
        function showPhotosModal(index, type) {
            let entry;
            if (type === 'receiving') {
                const data = getCurrentDataArrays();
                entry = data.receiving[index];
            } else {
                const data = getCurrentDataArrays();
                entry = data.usage[index];
            }
            
            if (!entry || !entry.photos || entry.photos.length === 0) {
                return;
            }
            
            // Create modal for photos display
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
            modal.style.display = 'flex';
            modal.style.flexDirection = 'column';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.zIndex = '9999';
            modal.style.cursor = 'pointer';
            
            // Modal header
            const header = document.createElement('div');
            header.style.color = 'white';
            header.style.marginBottom = '20px';
            header.style.fontSize = '1.2rem';
            header.style.fontWeight = 'bold';
            header.textContent = `Photos (${entry.photos.length}) - Click anywhere to close`;
            modal.appendChild(header);
            
            // Photos container
            const photosContainer = document.createElement('div');
            photosContainer.style.display = 'flex';
            photosContainer.style.flexWrap = 'wrap';
            photosContainer.style.justifyContent = 'center';
            photosContainer.style.gap = '20px';
            photosContainer.style.maxWidth = '90%';
            photosContainer.style.maxHeight = '80%';
            photosContainer.style.overflow = 'auto';
            
            entry.photos.forEach((photo, photoIndex) => {
                const imgContainer = document.createElement('div');
                imgContainer.style.position = 'relative';
                imgContainer.style.margin = '10px';
                
                const img = document.createElement('img');
                img.src = photo;
                img.alt = `Photo ${photoIndex + 1}`;
                img.style.maxWidth = '200px';
                img.style.maxHeight = '200px';
                img.style.borderRadius = '10px';
                img.style.boxShadow = '0 0 20px rgba(255, 255, 255, 0.3)';
                img.style.cursor = 'pointer';
                
                imgContainer.appendChild(img);
                photosContainer.appendChild(imgContainer);
            });
            
            modal.appendChild(photosContainer);
            
            // Close modal on click
            modal.addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            document.body.appendChild(modal);
        }
        
        // Edit receiving entry
        function editReceivingEntry(index) {
            const data = getCurrentDataArrays();
            const entry = data.receiving[index];
            
            // Fill the form with existing data
            document.getElementById('receiving-date').value = entry.date;
            document.getElementById('material-name').value = entry.materialName;
            document.getElementById('quantity').value = entry.quantity;
            document.getElementById('invoice-no').value = entry.invoiceNo || '';
            
            // Handle photos
            receivingPhotosData = [...(entry.photos || [])]; // Create a copy of the photos array
            const previewContainer = document.getElementById('receiving-photos-preview');
            previewContainer.innerHTML = '';
            
            if (entry.photos && entry.photos.length > 0) {
                entry.photos.forEach((photo, index) => {
                    // Create preview element
                    const previewDiv = document.createElement('div');
                    previewDiv.style.position = 'relative';
                    previewDiv.style.display = 'inline-block';
                    
                    const img = document.createElement('img');
                    img.src = photo;
                    img.alt = `Photo ${index + 1}`;
                    img.style.maxWidth = '100px';
                    img.style.maxHeight = '100px';
                    img.style.borderRadius = '5px';
                    img.style.border = '2px solid #00c3ff';
                    
                    previewDiv.appendChild(img);
                    previewContainer.appendChild(previewDiv);
                });
            }
            
            // Remove the entry from the array
            if (currentEquipmentType === 'dc_cts') {
                dcCtsReceivingData.splice(index, 1);
                localStorage.setItem('dcCtsReceivingData', JSON.stringify(dcCtsReceivingData));
            } else {
                spdReceivingData.splice(index, 1);
                localStorage.setItem('spdReceivingData', JSON.stringify(spdReceivingData));
            }
            
            // Update UI
            updateStats();
            updateCharts();
            updateDataTables();
            
            // Switch to receiving tab
            showTab('receiving');
            
            alert('Entry loaded for editing. Make your changes and save.');
        }
        
        // Edit usage entry
        function editUsageEntry(index) {
            const data = getCurrentDataArrays();
            const entry = data.usage[index];
            
            // Fill the form with existing data
            document.getElementById('usage-date').value = entry.date;
            document.getElementById('site-id').value = entry.siteId;
            document.getElementById('sub-region').value = entry.subRegion;
            document.getElementById('used-quantity').value = entry.usedQuantity;
            document.getElementById('team-name').value = entry.teamName;
            document.getElementById('es-poc-name').value = entry.esPocName;
            
            // Handle photos
            usagePhotosData = [...(entry.photos || [])]; // Create a copy of the photos array
            const previewContainer = document.getElementById('usage-photos-preview');
            previewContainer.innerHTML = '';
            
            if (entry.photos && entry.photos.length > 0) {
                entry.photos.forEach((photo, index) => {
                    // Create preview element
                    const previewDiv = document.createElement('div');
                    previewDiv.style.position = 'relative';
                    previewDiv.style.display = 'inline-block';
                    
                    const img = document.createElement('img');
                    img.src = photo;
                    img.alt = `Photo ${index + 1}`;
                    img.style.maxWidth = '100px';
                    img.style.maxHeight = '100px';
                    img.style.borderRadius = '5px';
                    img.style.border = '2px solid #00c3ff';
                    
                    previewDiv.appendChild(img);
                    previewContainer.appendChild(previewDiv);
                });
            }
            
            // Remove the entry from the array
            if (currentEquipmentType === 'dc_cts') {
                dcCtsUsageData.splice(index, 1);
                localStorage.setItem('dcCtsUsageData', JSON.stringify(dcCtsUsageData));
            } else {
                spdUsageData.splice(index, 1);
                localStorage.setItem('spdUsageData', JSON.stringify(spdUsageData));
            }
            
            // Update UI
            updateStats();
            updateCharts();
            updateDataTables();
            
            // Switch to usage tab
            showTab('usage');
            
            alert('Entry loaded for editing. Make your changes and save.');
        }
        
        // Delete receiving entry
        function deleteReceivingEntry(index) {
            if (confirm('Are you sure you want to delete this receiving entry?')) {
                if (currentEquipmentType === 'dc_cts') {
                    dcCtsReceivingData.splice(index, 1);
                    localStorage.setItem('dcCtsReceivingData', JSON.stringify(dcCtsReceivingData));
                } else {
                    spdReceivingData.splice(index, 1);
                    localStorage.setItem('spdReceivingData', JSON.stringify(spdReceivingData));
                }
                
                // Update UI
                updateStats();
                updateCharts();
                updateDataTables();
                
                alert('Receiving entry deleted successfully.');
            }
        }
        
        // Delete usage entry
        function deleteUsageEntry(index) {
            if (confirm('Are you sure you want to delete this usage entry?')) {
                if (currentEquipmentType === 'dc_cts') {
                    dcCtsUsageData.splice(index, 1);
                    localStorage.setItem('dcCtsUsageData', JSON.stringify(dcCtsUsageData));
                } else {
                    spdUsageData.splice(index, 1);
                    localStorage.setItem('spdUsageData', JSON.stringify(spdUsageData));
                }
                
                // Update UI
                updateStats();
                updateCharts();
                updateDataTables();
                
                alert('Usage entry deleted successfully.');
            }
        }
        
        // Format date for display as DD-MMM-YYYY
        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                              "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const month = monthNames[date.getMonth()];
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }
        
        // Show screenshot previews
        function showScreenshotPreviews(receivingImg, usageImg, equipmentType) {
            // Create a modal to show screenshots
            const modal = document.createElement('div');
            modal.id = 'screenshot-modal';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
            modal.style.display = 'flex';
            modal.style.flexDirection = 'column';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.zIndex = '10000';
            modal.style.padding = '20px';
            modal.style.overflow = 'auto';
            
            // Modal header
            const header = document.createElement('div');
            header.style.color = 'white';
            header.style.marginBottom = '20px';
            header.style.textAlign = 'center';
            header.innerHTML = `
                <h2>Screenshots Prepared for ${equipmentType}</h2>
                <p>Right-click each image and select "Save image as..." to download</p>
                <p>Then attach these images to your WhatsApp message</p>
                <button onclick="document.body.removeChild(document.getElementById('screenshot-modal'))" 
                        style="margin-top: 15px; padding: 10px 20px; background: #25D366; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    Close This Window
                </button>
            `;
            modal.appendChild(header);
            
            // Screenshots container
            const screenshotsContainer = document.createElement('div');
            screenshotsContainer.style.display = 'flex';
            screenshotsContainer.style.flexWrap = 'wrap';
            screenshotsContainer.style.justifyContent = 'center';
            screenshotsContainer.style.gap = '30px';
            screenshotsContainer.style.maxWidth = '100%';
            
            // Receiving screenshot
            const receivingContainer = document.createElement('div');
            receivingContainer.style.textAlign = 'center';
            receivingContainer.innerHTML = `
                <h3 style="color: white; margin-bottom: 10px;">Receiving Records</h3>
                <img src="${receivingImg}" alt="Receiving Records" style="max-width: 90vw; max-height: 40vh; border: 3px solid #25D366; border-radius: 10px;">
            `;
            screenshotsContainer.appendChild(receivingContainer);
            
            // Usage screenshot
            const usageContainer = document.createElement('div');
            usageContainer.style.textAlign = 'center';
            usageContainer.innerHTML = `
                <h3 style="color: white; margin-bottom: 10px;">Usage Records</h3>
                <img src="${usageImg}" alt="Usage Records" style="max-width: 90vw; max-height: 40vh; border: 3px solid #25D366; border-radius: 10px;">
            `;
            screenshotsContainer.appendChild(usageContainer);
            
            modal.appendChild(screenshotsContainer);
            document.body.appendChild(modal);
        }
        
        // Export to Excel
        function exportToExcel() {
            // Prepare data for export
            const dcCtsData = [
                ['DC CTs Receiving Records'],
                ['Date', 'Material Name', 'Quantity', 'Invoice No', 'Photo Count']
            ];
            
            dcCtsReceivingData.forEach(item => {
                dcCtsData.push([
                    formatDate(item.date),
                    item.materialName,
                    item.quantity,
                    item.invoiceNo || 'N/A',
                    item.photos ? item.photos.length : 0
                ]);
            });
            
            dcCtsData.push([]); // Empty row
            dcCtsData.push([]); // Empty row
            dcCtsData.push([
                ['DC CTs Usage Records'],
                ['Date', 'Site ID', 'Region', 'Used Quantity', 'Team Name', 'ES POC Name', 'Photo Count']
            ]);
            
            dcCtsUsageData.forEach(item => {
                dcCtsData.push([
                    formatDate(item.date),
                    item.siteId,
                    item.subRegion,
                    item.usedQuantity,
                    item.teamName,
                    item.esPocName,
                    item.photos ? item.photos.length : 0
                ]);
            });
            
            dcCtsData.push([]); // Empty row
            dcCtsData.push([]); // Empty row
            
            const spdData = [
                ['SPD Receiving Records'],
                ['Date', 'Material Name', 'Quantity', 'Invoice No', 'Photo Count']
            ];
            
            spdReceivingData.forEach(item => {
                spdData.push([
                    formatDate(item.date),
                    item.materialName,
                    item.quantity,
                    item.invoiceNo || 'N/A',
                    item.photos ? item.photos.length : 0
                ]);
            });
            
            spdData.push([]); // Empty row
            spdData.push([]); // Empty row
            spdData.push([
                ['SPD Usage Records'],
                ['Date', 'Site ID', 'Region', 'Used Quantity', 'Team Name', 'ES POC Name', 'Photo Count']
            ]);
            
            spdUsageData.forEach(item => {
                spdData.push([
                    formatDate(item.date),
                    item.siteId,
                    item.subRegion,
                    item.usedQuantity,
                    item.teamName,
                    item.esPocName,
                    item.photos ? item.photos.length : 0
                ]);
            });
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            const dcCtsWs = XLSX.utils.aoa_to_sheet(dcCtsData);
            const spdWs = XLSX.utils.aoa_to_sheet(spdData);
            XLSX.utils.book_append_sheet(wb, dcCtsWs, 'DC CTs Data');
            XLSX.utils.book_append_sheet(wb, spdWs, 'SPD Data');
            XLSX.writeFile(wb, 'equipment_data.xlsx');
        }
        
        // Share data via WhatsApp Business with screenshots
        function shareData() {
            // Show loading message
            alert('Preparing screenshots for sharing...\nThis may take a moment.');
            
            // Get the current equipment type
            const equipmentType = currentEquipmentType === 'dc_cts' ? 'DC-CTs' : 'SPD';
            
            // Get the data table elements
            const receivingTable = document.querySelector('#receiving-table');
            const usageTable = document.querySelector('#usage-table');
            
            if (!receivingTable || !usageTable) {
                alert('Could not find data tables to screenshot.');
                return;
            }
            
            // Use html2canvas to capture screenshots
            Promise.all([
                html2canvas(receivingTable, {
                    scale: 2,
                    useCORS: true,
                    logging: false
                }),
                html2canvas(usageTable, {
                    scale: 2,
                    useCORS: true,
                    logging: false
                })
            ]).then(canvases => {
                // Convert to data URLs
                const receivingImg = canvases[0].toDataURL('image/png');
                const usageImg = canvases[1].toDataURL('image/png');
                
                // Create a summary message
                const receivingCount = getCurrentDataArrays().receiving.length;
                const usageCount = getCurrentDataArrays().usage.length;
                
                const message = `*Equipment Data Report - ${equipmentType}*\n\n` +
                               `*Date:* ${new Date().toLocaleDateString()}\n` +
                               `*Time:* ${new Date().toLocaleTimeString()}\n\n` +
                               `*Receiving Records:* ${receivingCount} entries\n` +
                               `*Usage Records:* ${usageCount} entries\n\n` +
                               `Please find the detailed records attached.`;
                
                // Encode for WhatsApp
                const encodedMessage = encodeURIComponent(message);
                
                // Open WhatsApp Business with the message
                const whatsappUrl = `https://web.whatsapp.com/send?text=${encodedMessage}`;
                
                // Open in a new tab
                const whatsappWindow = window.open(whatsappUrl, '_blank');
                
                // Inform user about the screenshots
                setTimeout(() => {
                    alert('WhatsApp Business has been opened with a pre-filled message.\n\n' +
                          'Screenshots have been prepared. To send them:\n' +
                          '1. Right-click on the first screenshot below and select "Save image as..." \n' +
                          '2. Repeat for the second screenshot\n' +
                          '3. Attach these images to your WhatsApp message\n\n' +
                          'Tip: You can also use the "Export to Excel" button to share data in spreadsheet format.');
                    
                    // Create a container to show the screenshots
                    showScreenshotPreviews(receivingImg, usageImg, equipmentType);
                }, 3000);
            }).catch(error => {
                console.error('Error capturing screenshots:', error);
                // Fallback to text sharing
                shareTextData(equipmentType);
            });
        }
        
        // Clear all data
        function clearAllData() {
            if (confirm('Are you sure you want to clear all equipment data? This action cannot be undone.')) {
                dcCtsReceivingData = [];
                dcCtsUsageData = [];
                spdReceivingData = [];
                spdUsageData = [];
                localStorage.removeItem('dcCtsReceivingData');
                localStorage.removeItem('dcCtsUsageData');
                localStorage.removeItem('spdReceivingData');
                localStorage.removeItem('spdUsageData');
                
                // Update UI
                updateStats();
                updateCharts();
                updateDataTables();
                
                alert('All equipment data has been cleared.');
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default for both forms
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('receiving-date').value = today;
            document.getElementById('usage-date').value = today;
            
            // Update stats and tables on page load
            updateStats();
            updateDataTables();
        });
    </script>
</body>
</html>