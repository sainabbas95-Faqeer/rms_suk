<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPD Alarm Analysis Dashboard</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-3d"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Add Orbitron font for better 7-segment display -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            min-height: 100vh;
            color: #333;
            padding: 20px;
            overflow-x: hidden;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Floating back button */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            animation: floating 3s ease-in-out infinite;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-5px);
        }

        .back-button i {
            font-size: 24px;
            color: #333;
        }

        /* Fixed header without distracting background */
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px 40px;
            border-radius: 20px;
            margin-bottom: 35px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: float 6s ease-in-out infinite;
            border: 1px solid rgba(255, 255, 255, 0.3);
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 70%);
            transform: rotate(30deg);
            animation: shine 8s infinite linear;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }

        @keyframes shine {
            0% { transform: rotate(30deg) translateX(-100%); }
            100% { transform: rotate(30deg) translateX(100%); }
        }

        .header .logo {
            position: absolute;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            height: 70px;
            width: auto;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .header .logo:hover {
            transform: translateY(-50%) scale(1.1);
        }

        .header .header-content {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .header h1 {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 2.8rem;
            margin-bottom: 10px;
            color: #333; /* Fixed color for heading */
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-weight: 800;
            letter-spacing: 1px;
        }

        .header .date-info {
            position: absolute;
            top: 25px;
            right: 30px;
            font-size: 14px;
            color: #00008B;
            font-weight: bold;
            text-align: right;
            background: rgba(255, 255, 255, 0.7);
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .header p {
            text-align: center;
            color: #666;
            margin: 5px 0 0 0;
            font-size: 16px;
            font-weight: 500;
        }

        .footer-text {
            position: fixed;
            bottom: 15px;
            right: 15px;
            font-size: 14px;
            color: #fff;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 15px;
            border-radius: 10px;
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: floating 3s ease-in-out infinite;
        }

        .visit-counter {
            position: fixed;
            bottom: 50px;
            right: 15px;
            font-size: 14px;
            color: #fff;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 15px;
            border-radius: 10px;
            z-index: 1000;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            animation: floating 3s ease-in-out infinite;
            animation-delay: 0.5s;
        }

        .visit-counter:hover {
            background: rgba(0, 0, 0, 0.5);
            transform: translateY(-3px);
        }

        .file-input {
            display: none;
        }

        .results-section {
            display: none;
            background: rgba(255, 255, 255, 0.9);
            padding: 35px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            margin-bottom: 35px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Enhanced stats grid with floating cards - 5 cards in one row, center-aligned */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* Exactly 5 columns for 5 cards */
            gap: 20px;
            margin-bottom: 40px;
            justify-content: center;
            align-items: center;
            justify-items: center;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            transform: perspective(1000px) rotateX(0deg);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            animation: floating 3s ease-in-out infinite;
            justify-self: center;
            align-self: center;
            width: 100%;
            max-width: 220px;
        }

        /* More colorful cards with distinct backgrounds */
        .stat-card:nth-child(1) { 
            background: linear-gradient(135deg, #FF9A8B 0%, #FF6A88 50%, #FF99AC 100%); 
            color: white;
            animation-delay: 0s; 
        }
        .stat-card:nth-child(2) { 
            background: linear-gradient(135deg, #43CBFF 0%, #9708CC 50%, #43CBFF 100%); 
            color: white;
            animation-delay: 0.3s; 
        }
        .stat-card:nth-child(3) { 
            background: linear-gradient(135deg, #5EFCE8 0%, #736EFE 50%, #5EFCE8 100%); 
            color: white;
            animation-delay: 0.6s; 
        }
        .stat-card:nth-child(4) { 
            background: linear-gradient(135deg, #FAD961 0%, #F76B1C 50%, #FAD961 100%); 
            color: white;
            animation-delay: 0.9s; 
        }
        .stat-card:nth-child(5) { 
            background: linear-gradient(135deg, #8A2BE2 0%, #4B0082 50%, #8A2BE2 100%); 
            color: white;
            animation-delay: 1.2s; 
        }

        .stat-card:hover {
            transform: perspective(1000px) translateY(-15px) scale(1.05);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        /* Digital 7-segment font for all stat numbers with fallbacks */
        @font-face {
            font-family: 'Digital7';
            src: url('https://cdn.jsdelivr.net/npm/@fontsource/digital-numbers@4.5.0/files/digital-numbers-latin-ext-400-normal.woff2') format('woff2'),
                 url('https://cdn.jsdelivr.net/npm/@fontsource/digital-numbers@4.5.0/files/digital-numbers-latin-ext-400-normal.woff') format('woff');
            font-display: swap;
        }

        .stat-number {
            font-family: 'Digital7', 'Orbitron', 'Courier New', 'Consolas', 'Monaco', monospace;
            font-size: 3rem;
            font-weight: normal;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 255, 255, 0.3);
            color: white;
            letter-spacing: 2px;
            animation: pulse 1.5s infinite;
            /* Add 7-segment display effect */
            background: linear-gradient(to bottom, rgba(255,255,255,0.1), rgba(0,0,0,0.2));
            padding: 5px 10px;
            border-radius: 5px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3), 0 0 5px rgba(255,255,255,0.2);
            /* Ensure the numbers are clearly visible */
            line-height: 1.2;
            /* Add subtle glow effect */
            filter: drop-shadow(0 0 5px rgba(255,255,255,0.5));
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
            100% { transform: scale(1); opacity: 1; }
        }

        .stat-label {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        /* Enhanced chart containers with floating effect */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        /* 7-segment display style for bar chart numbers */
        .bar-chart-number {
            font-family: 'Orbitron', 'Digital7', 'Courier New', monospace;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
            letter-spacing: 1px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            animation: floating 3s ease-in-out infinite;
            min-width: 300px;
        }

        .chart-container:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        }

        .chart-container:nth-child(1) { animation-delay: 0.2s; }
        .chart-container:nth-child(2) { animation-delay: 0.7s; }

        .chart-container h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.4rem;
            font-weight: 700;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .status {
            padding: 18px;
            border-radius: 15px;
            margin: 20px 0;
            font-weight: bold;
            font-size: 1.1rem;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .success {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
            border: 2px solid #28a745;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.2);
        }

        .error {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            border: 2px solid #dc3545;
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.2);
        }

        .loading {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 2px solid #ffc107;
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.2);
        }

        /* Export section */
        .export-section {
            background: rgba(255, 255, 255, 0.9);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            margin-top: 30px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: floating 3s ease-in-out infinite;
            animation-delay: 1s;
        }

        .export-section h2 {
            color: #333;
            font-size: 2.2rem;
            margin-bottom: 30px;
            font-weight: 800;
        }

        .export-buttons {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .export-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 22px 40px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .export-btn:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.6);
        }

        .export-btn-ppt {
            background: linear-gradient(135deg, #d35400, #e67e22);
        }

        .export-btn-ppt:hover {
            box-shadow: 0 15px 35px rgba(211, 84, 0, 0.6);
        }

        .export-btn-excel {
            background: linear-gradient(135deg, #1e7e34, #28a745);
        }

        .export-btn-excel:hover {
            box-shadow: 0 15px 35px rgba(30, 126, 52, 0.6);
        }

        .export-btn-pdf {
            background: linear-gradient(135deg, #c82333, #dc3545);
        }

        .export-btn-pdf:hover {
            box-shadow: 0 15px 35px rgba(200, 35, 51, 0.6);
        }

        .export-btn .icon {
            font-size: 28px;
        }

        /* Floating animation */
        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        /* Responsive design */
        @media (max-width: 1200px) {
            .chart-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
            
            .stats-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .header .date-info {
                position: static;
                margin-top: 15px;
                font-size: 12px;
            }
            
            .chart-grid {
                grid-template-columns: 1fr;
            }
            
            .export-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .export-btn {
                width: 100%;
                max-width: 300px;
                justify-content: center;
            }
            
            .stat-number {
                font-size: 2rem;
            }
            
            /* Responsive grid for stats cards - 5 cards in one row */
            .stats-grid {
                grid-template-columns: repeat(5, 1fr);
            }
            
            .stat-card {
                max-width: 100%;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 15px 10px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .results-section {
                padding: 20px;
            }
            
            .stat-card {
                padding: 20px;
            }
            
            .stat-number {
                font-size: 1.8rem;
            }
            
            /* Stack all cards on mobile */
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .file-drop-zone {
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin: 20px 0;
            border: 2px dashed #ccc;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .file-drop-zone h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .file-drop-zone p {
            color: #666;
            margin-bottom: 10px;
        }

        .file-drop-zone.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .file-upload-icon {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .file-upload-icon:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-3px);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Floating back button -->
        <div class="back-button" onclick="window.location.href='welcome.html'" title="Back to Welcome Page">
            <i class="fas fa-arrow-left"></i>
        </div>

        <div class="header">
            <img src="Logo.jpeg" alt="RMS Logo" class="logo" onclick="window.location.href='column_l_3d_chart.html'">
            <div class="date-info" id="dateInfo">Data till<br><span id="displayDate"></span><br><span id="displayTime" style="color: red; font-weight: bold;"></span></div>
            <div class="header-content">
                <h1>SPD ALARM ANALYSIS DASHBOARD</h1>
                <p>Comprehensive SPD Alarm Data Analysis</p>
            </div>
        </div>

        <!-- Footer text -->
        <div class="footer-text">Database created by - Abbas Enterprises - Lakhi - 2025</div>
        
        <!-- Visit counter -->
        <div class="visit-counter" id="visitCounter" onclick="openVisitHistory()">Page Visits: <span id="visitCount">0</span></div>

        <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls" style="display: none;" />
        <div id="uploadStatus" style="display: none;"></div>

        <!-- Minimal file upload icon (hidden by default, shown only on error) -->
        <div id="fileUploadIcon" class="file-upload-icon" style="display: none; position: fixed; top: 20px; right: 20px; background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); z-index: 1000; border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease;" title="Load Excel File">
            <i class="fas fa-file-upload" style="font-size: 20px; color: #333;"></i>
        </div>

        <!-- File drop zone for local access (hidden by default) -->
        <div id="fileDropZone" class="file-drop-zone" style="display: none; background: rgba(255, 255, 255, 0.9); padding: 30px; border-radius: 20px; text-align: center; margin: 20px 0; border: 2px dashed #ccc; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);">
            <h3>üìÅ Drop SPD.xlsx file here or click to select</h3>
            <p>When opening this page directly (file://), browser security restrictions prevent automatic file loading.</p>
            <p>Please select the SPD.xlsx file to load accurate data.</p>
            <button id="selectFileButton" class="export-btn" style="margin-top: 20px;">Select SPD.xlsx File</button>
        </div>

        <div class="results-section" id="resultsSection">
            <!-- Stats will be populated here -->
            <div class="stats-grid" id="statsGrid">
                <!-- Stats will be populated by JavaScript -->
            </div>

            <div class="chart-grid">
                <div class="chart-container">
                    <h3>SPD Alarms By Aging</h3>
                    <div class="chart-wrapper">
                        <canvas id="agingPieChart" class="pie-3d"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>SPD alarms - Reasons</h3>
                    <div class="chart-wrapper">
                        <canvas id="domainBarChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>SPD Alarms - Region Wise</h3>
                    <div class="chart-wrapper">
                        <canvas id="regionBarChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Export Buttons Section -->
            <div class="export-section">
                <h2>üì• Export Dashboard</h2>
                <div class="export-buttons">
                    <button class="export-btn export-btn-excel" onclick="exportToExcel()" title="Export all data to Excel spreadsheet">
                        <span class="icon">üìó</span>
                        <span>Export to Excel</span>
                    </button>
                    <button class="export-btn export-btn-pdf" onclick="exportToPDF()" title="Export dashboard as PDF document">
                        <span class="icon">üìÑ</span>
                        <span>Export to PDF</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Set the date in header (previous day) and current time
        function setPreviousDate() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            const dayName = days[yesterday.getDay()];
            const monthName = months[yesterday.getMonth()];
            const date = yesterday.getDate();
            const year = yesterday.getFullYear();
            
            const formattedDate = `${dayName}, ${monthName} ${date < 10 ? '0' + date : date}, ${year}`;
            document.getElementById('displayDate').textContent = formattedDate;
            
            // Update time
            updateTime();
        }
        
        // Function to update current time
        function updateTime() {
            const now = new Date();
            let hours = now.getHours();
            let minutes = now.getMinutes();
            let seconds = now.getSeconds();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            
            hours = hours % 12;
            hours = hours ? hours : 12; // 0 should be 12
            minutes = minutes < 10 ? '0' + minutes : minutes;
            seconds = seconds < 10 ? '0' + seconds : seconds;
            
            const timeString = `${hours}:${minutes}:${seconds} ${ampm}`;
            const timeElement = document.getElementById('displayTime');
            if (timeElement) {
                timeElement.textContent = timeString;
            }
        }
        
        // Call on page load
        setPreviousDate();
        setInterval(updateTime, 1000);
        
        // Initialize visit counter
        function initVisitCounter() {
            let visitCount = localStorage.getItem('spdVisitCount') || 0;
            visitCount = parseInt(visitCount) + 1;
            localStorage.setItem('spdVisitCount', visitCount);
            document.getElementById('visitCount').textContent = visitCount;
        }
        
        // Open visit history
        function openVisitHistory() {
            // This would open a visit history page if implemented
            alert('Visit history feature coming soon!');
        }
        
        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
            statusDiv.style.display = 'block';
            
            // Hide after 5 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
        
        // Global chart instances
        let agingPieChartInstance = null;
        let domainBarChartInstance = null;
        let regionBarChartInstance = null;
        
        // Store raw data globally for access by details page
        let rawData = [];
        
        // Analysis data storage
        let spdAnalysisData = {
            totalSPDAlarms: 0,
            enfraAlarms: 0,
            smsLDAlarms: 0,
            resolvedAlarms: 0,
            otherAlarms: 0,
            agingCategories: {},
            domains: {},
            regions: {}
        };
        
        // Generate colorful colors for charts
        function generateColorfulColors(count) {
            const backgroundColors = [];
            const borderColors = [];
            
            for (let i = 0; i < count; i++) {
                // Generate vibrant colors using HSL
                const hue = (i * 360 / count) % 360;
                const saturation = 70 + Math.random() * 30; // 70-100%
                const lightness = 40 + Math.random() * 30;  // 40-70%
                
                backgroundColors.push(`hsla(${hue}, ${saturation}%, ${lightness}%, 0.7)`);
                borderColors.push(`hsla(${hue}, ${saturation}%, ${lightness}%, 1)`);
            }
            
            return { backgroundColors, borderColors };
        }
        
        // Load data from SPD.xlsx file (as per project requirements)
        function loadSPDData() {
            console.log('Loading data from SPD.xlsx...');
            showStatus('üì• Loading data from Excel...', 'loading');
            
            // First try the File System Access API (modern browsers)
            if ('showOpenFilePicker' in window) {
                console.log('Attempting to use File System Access API');
                loadWithFileSystemAPI();
                return;
            }
            
            // Check if we're running locally (file:// protocol)
            const isLocalFile = window.location.protocol === 'file:';
            
            if (isLocalFile) {
                console.log('Running locally with file:// protocol - attempting auto-load of SPD.xlsx');
                // Try to auto-load the file
                autoLoadSPDFile();
            } else {
                // Try to load the SPD.xlsx file directly via fetch
                fetch('SPD.xlsx')
                    .then(response => {
                        console.log('Fetch response status:', response.status);
                        if (!response.ok) {
                            throw new Error('Network response was not ok: ' + response.status + ' ' + response.statusText);
                        }
                        return response.arrayBuffer();
                    })
                    .then(data => {
                        console.log('SPD.xlsx file loaded successfully, size:', data.byteLength);
                        processSPDData(data);
                    })
                    .catch(error => {
                        console.error('Error loading SPD.xlsx:', error);
                        console.error('This might be due to browser security restrictions when opening files directly in browsers.');
                        console.error('When opening HTML files directly in browsers (file://), fetch requests to local files may be blocked.');
                        showStatus('‚ùå Error loading SPD.xlsx: ' + error.message, 'error');
                        // Initialize with sample data as fallback
                        initializeSampleData();
                    });
            }
        }
        
        // Load with File System Access API (modern approach)
        async function loadWithFileSystemAPI() {
            try {
                const [fileHandle] = await window.showOpenFilePicker({
                    types: [{
                        description: 'Excel Files',
                        accept: {
                            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'],
                            'application/vnd.ms-excel': ['.xls']
                        }
                    }],
                    excludeAcceptAllOption: true,
                    multiple: false
                });
                
                const file = await fileHandle.getFile();
                const arrayBuffer = await file.arrayBuffer();
                
                console.log('File loaded via File System Access API');
                showStatus('‚úÖ File loaded successfully via modern API', 'success');
                processSPDData(arrayBuffer);
            } catch (error) {
                console.log('File System Access API not available or user cancelled, falling back to traditional methods');
                // Fall back to traditional methods
                autoLoadSPDFile();
            }
        }
        
        // Auto-load DB file when running locally
        function autoLoadSPDFile() {
            console.log('Attempting to auto-load SPD.xlsx file');
            showStatus('üîÑ Attempting to auto-load SPD.xlsx file...', 'loading');
            
            // Method 1: Try fetch API
            fetch('SPD.xlsx')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Fetch failed with status: ' + response.status);
                    }
                    return response.arrayBuffer();
                })
                .then(data => {
                    console.log('SPD.xlsx file auto-loaded successfully using fetch');
                    showStatus('‚úÖ SPD.xlsx file loaded successfully', 'success');
                    processSPDData(data);
                })
                .catch(fetchError => {
                    console.log('Fetch method failed:', fetchError.message);
                    
                    // Method 2: Try XMLHttpRequest
                    try {
                        const xhr = new XMLHttpRequest();
                        xhr.open('GET', 'SPD.xlsx', true);
                        xhr.responseType = 'arraybuffer';
                        
                        xhr.onload = function() {
                            if (xhr.status === 200) {
                                console.log('SPD.xlsx file auto-loaded successfully using XMLHttpRequest');
                                showStatus('‚úÖ SPD.xlsx file loaded successfully', 'success');
                                processSPDData(xhr.response);
                            } else {
                                console.log('XMLHttpRequest failed with status:', xhr.status);
                                showMinimalUploadIcon();
                            }
                        };
                        
                        xhr.onerror = function() {
                            console.log('XMLHttpRequest encountered an error');
                            showMinimalUploadIcon();
                        };
                        
                        xhr.send();
                    } catch (xhrError) {
                        console.log('XMLHttpRequest method failed:', xhrError.message);
                        showMinimalUploadIcon();
                    }
                });
        }
        
        // Show minimal upload icon as fallback
        function showMinimalUploadIcon() {
            const fileUploadIcon = document.getElementById('fileUploadIcon');
            const fileInput = document.getElementById('fileInput');
            
            if (fileUploadIcon && fileInput) {
                fileUploadIcon.style.display = 'flex';
                showStatus('‚ö†Ô∏è Auto-loading failed. Click the upload icon to manually select SPD.xlsx', 'error');
                
                // Set up click handler for the upload icon
                fileUploadIcon.addEventListener('click', function() {
                    fileInput.click();
                });
                
                // Set up file input change handler
                fileInput.addEventListener('change', function(e) {
                    if (e.target.files && e.target.files[0]) {
                        const file = e.target.files[0];
                        if (file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls')) {
                            showStatus('üîÑ Processing selected file...', 'loading');
                            
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                try {
                                    const data = new Uint8Array(e.target.result);
                                    console.log('File loaded successfully');
                                    showStatus('‚úÖ File loaded successfully', 'success');
                                    processSPDData(data);
                                    
                                    // Hide the upload icon after successful load
                                    fileUploadIcon.style.display = 'none';
                                } catch (error) {
                                    console.error('Error processing file:', error);
                                    showStatus('‚ùå Error processing file: ' + error.message, 'error');
                                    initializeSampleData();
                                }
                            };
                            reader.onerror = function(error) {
                                console.error('Error reading file:', error);
                                showStatus('‚ùå Error reading file: ' + error.message, 'error');
                                initializeSampleData();
                            };
                            reader.readAsArrayBuffer(file);
                        } else {
                            showStatus('‚ùå Please select a valid Excel file (.xlsx or .xls)', 'error');
                        }
                    }
                });
            } else {
                // If even the minimal upload icon can't be shown, fall back to sample data
                console.log('Cannot show upload interface, using sample data');
                showStatus('‚ö†Ô∏è Cannot load file interface, using sample data', 'error');
                initializeSampleData();
            }
        }
        
        // Show file drop zone (only when needed)
        function showFileDropZone() {
            const fileDropZone = document.getElementById('fileDropZone');
            const selectFileButton = document.getElementById('selectFileButton');
            const fileInput = document.getElementById('fileInput');
            
            if (fileDropZone) {
                fileDropZone.style.display = 'block';
                showStatus('üìÅ Please select or drop the SPD.xlsx file to load accurate data', 'loading');
                
                // Set up file selection button
                if (selectFileButton) {
                    selectFileButton.addEventListener('click', function() {
                        fileInput.click();
                    });
                }
                
                // Set up file input change handler
                if (fileInput) {
                    fileInput.addEventListener('change', function(e) {
                        handleFileSelect(e);
                    });
                }
                
                // Set up drag and drop
                setupDragAndDrop();
            }
        }
        
        // Handle file selection
        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls')) {
                    console.log('File selected:', file.name);
                    showStatus('üîÑ Processing selected file...', 'loading');
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = new Uint8Array(e.target.result);
                            console.log('File read successfully, size:', data.byteLength);
                            processSPDData(data);
                            
                            // Hide the file drop zone
                            const fileDropZone = document.getElementById('fileDropZone');
                            if (fileDropZone) {
                                fileDropZone.style.display = 'none';
                            }
                        } catch (error) {
                            console.error('Error processing file:', error);
                            showStatus('‚ùå Error processing file: ' + error.message, 'error');
                            initializeSampleData();
                        }
                    };
                    reader.onerror = function(error) {
                        console.error('Error reading file:', error);
                        showStatus('‚ùå Error reading file: ' + error.message, 'error');
                        initializeSampleData();
                    };
                    reader.readAsArrayBuffer(file);
                } else {
                    showStatus('‚ùå Please select a valid Excel file (.xlsx or .xls)', 'error');
                }
            }
        }
        
        // Set up drag and drop functionality
        function setupDragAndDrop() {
            const fileDropZone = document.getElementById('fileDropZone');
            
            if (fileDropZone) {
                // Prevent default drag behaviors
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    fileDropZone.addEventListener(eventName, preventDefaults, false);
                    document.body.addEventListener(eventName, preventDefaults, false);
                });
                
                // Highlight drop area when item is dragged over it
                ['dragenter', 'dragover'].forEach(eventName => {
                    fileDropZone.addEventListener(eventName, highlight, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    fileDropZone.addEventListener(eventName, unhighlight, false);
                });
                
                // Handle dropped files
                fileDropZone.addEventListener('drop', handleDrop, false);
            }
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight() {
                fileDropZone.classList.add('dragover');
            }
            
            function unhighlight() {
                fileDropZone.classList.remove('dragover');
            }
        }
        
        // Handle file drop
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }
        
        // Handle files (process the first one)
        function handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                if (file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls')) {
                    console.log('File selected:', file.name);
                    showStatus('üîÑ Processing selected file...', 'loading');
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = new Uint8Array(e.target.result);
                            console.log('File read successfully, size:', data.byteLength);
                            processSPDData(data);
                            
                            // Hide the file drop zone
                            const fileDropZone = document.getElementById('fileDropZone');
                            if (fileDropZone) {
                                fileDropZone.style.display = 'none';
                            }
                        } catch (error) {
                            console.error('Error processing file:', error);
                            showStatus('‚ùå Error processing file: ' + error.message, 'error');
                            initializeSampleData();
                        }
                    };
                    reader.onerror = function(error) {
                        console.error('Error reading file:', error);
                        showStatus('‚ùå Error reading file: ' + error.message, 'error');
                        initializeSampleData();
                    };
                    reader.readAsArrayBuffer(file);
                } else {
                    showStatus('‚ùå Please select a valid Excel file (.xlsx or .xls)', 'error');
                }
            }
        }
        
        // Process SPD data from Excel file
        function processSPDData(data) {
            try {
                console.log('Processing Excel data...');
                showStatus('üîÑ Processing Excel data...', 'loading');
                
                // Check if data is valid
                if (!data || data.byteLength === 0) {
                    throw new Error('No data received or data is empty');
                }
                
                const workbook = XLSX.read(data, { type: 'array' });
                console.log('Workbook loaded:', workbook);
                
                // Check if workbook has sheets
                if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                    throw new Error('No sheets found in Excel file');
                }
                
                // Get the first worksheet
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                console.log('Worksheet loaded:', firstSheetName);
                
                // Convert to JSON
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                console.log('Data converted to JSON. Rows:', jsonData.length);
                
                if (jsonData.length === 0) {
                    throw new Error('No data found in Excel file');
                }
                
                // Log first few rows for debugging
                console.log('First 3 rows of data:', jsonData.slice(0, 3));
                
                // Analyze the data
                analyzeSPDData(jsonData);
                
                // Display results
                displayResults();
                showStatus('‚úÖ Excel data loaded and analyzed successfully', 'success');
            } catch (error) {
                console.error('Error processing Excel data:', error);
                console.error('Stack trace:', error.stack);
                showStatus('‚ùå Error processing Excel data: ' + error.message, 'error');
                // Initialize with sample data as fallback
                initializeSampleData();
            }
        }
        
        // Analyze SPD data
        function analyzeSPDData(data) {
            console.log('Analyzing SPD data...');
            
            // Store raw data for details page
            rawData = data;
            
            // Reset analysis data
            spdAnalysisData = {
                totalSPDAlarms: 0,
                enfraAlarms: 0,
                smsLDAlarms: 0,
                resolvedAlarms: 0,
                otherAlarms: 0,
                agingCategories: {},
                domains: {},
                regions: {}
            };
            
            // More robust header detection
            let startIndex = 0;
            if (data.length > 0) {
                const firstRow = data[0];
                // Check multiple columns for header indicators
                const firstCell = firstRow[0] || '';
                const secondCell = firstRow[1] || '';
                const thirdCell = firstRow[2] || '';
                
                // Common header indicators
                const headerIndicators = ['site', 'name', 'id', 'alarm', 'date', 'time', 'location'];
                const isFirstRowHeader = headerIndicators.some(indicator => 
                    (typeof firstCell === 'string' && firstCell.toLowerCase().includes(indicator)) ||
                    (typeof secondCell === 'string' && secondCell.toLowerCase().includes(indicator)) ||
                    (typeof thirdCell === 'string' && thirdCell.toLowerCase().includes(indicator))
                );
                
                if (isFirstRowHeader) {
                    startIndex = 1;
                    console.log('Header row detected, skipping first row');
                } else {
                    console.log('No header row detected, processing all rows');
                }
            }
            
            console.log('Processing data from row index:', startIndex);
            console.log('Total rows to process:', data.length - startIndex);
            
            // Process each row
            for (let i = startIndex; i < data.length; i++) {
                const row = data[i];
                
                // Log first few rows for debugging
                if (i < startIndex + 10) {
                    console.log(`Row ${i}:`, row);
                }
                
                // Column G is index 6 (7th column) - SPD identification
                const columnG = row[6] || '';
                
                // Column L is index 11 (12th column) - Alarm type
                const columnL = row[11] || '';
                
                // Log specific columns for debugging
                if (i < startIndex + 10) {
                    console.log(`Row ${i} - Column G: "${columnG}", Column L: "${columnL}"`);
                }
                
                // Count "SPD" in Column G for total SPD alarms
                if (typeof columnG === 'string' && columnG.trim().toUpperCase() === 'SPD') {
                    spdAnalysisData.totalSPDAlarms++;
                    if (i < startIndex + 10) console.log(`Row ${i}: Found SPD alarm in Column G`);
                }
                
                // Count different types in Column L
                const trimmedColumnL = typeof columnL === 'string' ? columnL.trim().toUpperCase() : '';
                switch(trimmedColumnL) {
                    case 'ENFRA':
                        spdAnalysisData.enfraAlarms++;
                        if (i < startIndex + 10) console.log(`Row ${i}: Found ENFRA alarm`);
                        break;
                    case 'SMS LD':
                        spdAnalysisData.smsLDAlarms++;
                        if (i < startIndex + 10) console.log(`Row ${i}: Found SMS LD alarm`);
                        break;
                    case 'RESOLVED':
                        spdAnalysisData.resolvedAlarms++;
                        if (i < startIndex + 10) console.log(`Row ${i}: Found RESOLVED alarm`);
                        break;
                    default:
                        // Count as "Others" if not one of the specific types
                        if (trimmedColumnL && trimmedColumnL !== '' && trimmedColumnL !== 'ENFRA') {
                            spdAnalysisData.otherAlarms++;
                            if (i < startIndex + 10) console.log(`Row ${i}: Found OTHER alarm: "${trimmedColumnL}"`);
                        }
                        break;
                }
                
                // Process aging categories (Column F - index 5)
                const columnF = row[5] || '';
                if (columnF) {
                    const agingCategory = String(columnF).trim();
                    spdAnalysisData.agingCategories[agingCategory] = (spdAnalysisData.agingCategories[agingCategory] || 0) + 1;
                }
                
                // Process reasons (Column K - index 10) for domain bar chart
                const columnK = row[10] || '';
                if (columnK) {
                    const reason = String(columnK).trim();
                    spdAnalysisData.domains[reason] = (spdAnalysisData.domains[reason] || 0) + 1;
                }
                
                // Process regions (Column C - index 2) for region bar chart
                const columnC = row[2] || '';
                if (columnC) {
                    const region = String(columnC).trim();
                    spdAnalysisData.regions[region] = (spdAnalysisData.regions[region] || 0) + 1;
                }
            }
            
            console.log('SPD Analysis Results:', spdAnalysisData);
            console.log('Total alarms counted:', 
                spdAnalysisData.totalSPDAlarms + 
                spdAnalysisData.enfraAlarms + 
                spdAnalysisData.smsLDAlarms +
                spdAnalysisData.resolvedAlarms +
                spdAnalysisData.otherAlarms);
        }
        
        // Initialize with sample data as fallback
        function initializeSampleData() {
            console.log('Initializing with sample data...');
            
            // Check if we're running locally
            const isLocalFile = window.location.protocol === 'file:';
            let statusMessage = '‚ö†Ô∏è Using sample data - Excel loading failed';
            
            if (isLocalFile) {
                statusMessage += '. For accurate data, please select the SPD.xlsx file above or use a local web server.';
            }
            
            showStatus(statusMessage, 'error');
            
            // Reset analysis data with more realistic sample values
            spdAnalysisData = {
                totalSPDAlarms: 8,  // Updated to match expected count
                enfraAlarms: 0,     // Set to 0 as Enfra alarms should be removed
                smsLDAlarms: 5,     // Updated sample value
                resolvedAlarms: 2,  // New card value
                otherAlarms: 4,     // New card value
                agingCategories: {
                    '01 - 10 Days': 3,
                    '11 - 30 Days': 2,
                    '31 - 100 Days': 1,
                    '100+ Days': 1,
                    '180+ Days': 1
                },
                domains: {
                    'Sukkur': 3,
                    'Jacob Abad': 2,
                    'Larkana': 2,
                    'Other': 1
                },
                regions: {
                    'Sukkur': 4,
                    'Jacob Abad': 2,
                    'Larkana': 2,
                    'Shikarpur': 1
                }
            };
            
            console.log('Sample SPD Analysis Results:', spdAnalysisData);
            displayResults();
        }
        
        // Display statistics cards
        function displayStats() {
            const statsGrid = document.getElementById('statsGrid');
            if (!statsGrid) return;
            
            statsGrid.innerHTML = `
                <div class="stat-card" onclick="showSPDData('spd')">
                    <div class="stat-number">${spdAnalysisData.totalSPDAlarms}</div>
                    <div class="stat-label">Total SPD Alarms</div>
                </div>
                <div class="stat-card" onclick="showSPDData('enfra')">
                    <div class="stat-number">${spdAnalysisData.enfraAlarms}</div>
                    <div class="stat-label">SPD Alarms - Enfra End</div>
                </div>
                <div class="stat-card" onclick="showSPDData('smsld')">
                    <div class="stat-number">${spdAnalysisData.smsLDAlarms}</div>
                    <div class="stat-label">SPD Alarms - SMS LD End</div>
                </div>
                <div class="stat-card" onclick="showSPDData('resolved')">
                    <div class="stat-number">${spdAnalysisData.resolvedAlarms}</div>
                    <div class="stat-label">Resolved Alarms</div>
                </div>
                <div class="stat-card" onclick="showSPDData('others')">
                    <div class="stat-number">${spdAnalysisData.otherAlarms}</div>
                    <div class="stat-label">Others</div>
                </div>
            `;
        }
        
        // Show SPD data based on filter
        function showSPDData(filterType) {
            // Store the raw data in localStorage so the details page can access it
            try {
                if (rawData && rawData.length > 0) {
                    console.log('Storing raw data in localStorage for filter:', filterType);
                    console.log('Raw data rows:', rawData.length);
                    console.log('First few rows:', rawData.slice(0, 3));
                    
                    // Count SPD alarms in the data we're about to store
                    let spdCount = 0;
                    const startIndex = rawData.length > 0 && typeof rawData[0][0] === 'string' && rawData[0][0].toLowerCase().includes('site') ? 1 : 0;
                    for (let i = startIndex; i < Math.min(rawData.length, startIndex + 20); i++) {
                        const row = rawData[i];
                        const columnG = row[6] || '';
                        if (typeof columnG === 'string' && columnG.trim().toUpperCase() === 'SPD') {
                            spdCount++;
                        }
                        if (i < startIndex + 10) {
                            console.log(`Dashboard Row ${i}: Column G="${columnG}", Column L="${row[11] || ''}"`);
                        }
                    }
                    console.log('SPD count in data being stored:', spdCount);
                    
                    // Check data size before storing
                    const dataString = JSON.stringify(rawData);
                    console.log('Data size in bytes:', dataString.length);
                    
                    localStorage.setItem('spdData', dataString);
                    console.log('Raw data stored in localStorage for filter:', filterType);
                    
                    // Verify data was stored correctly
                    const storedData = localStorage.getItem('spdData');
                    if (storedData) {
                        console.log('Stored data size in bytes:', storedData.length);
                    }
                } else {
                    console.warn('No raw data available to store');
                    // Try to load data directly and store it
                    fetch('SPD.xlsx')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok: ' + response.status);
                            }
                            return response.arrayBuffer();
                        })
                        .then(data => {
                            const workbook = XLSX.read(data, { type: 'array' });
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                            
                            console.log('Directly loaded SPD.xlsx for storage, rows:', jsonData.length);
                            localStorage.setItem('spdData', JSON.stringify(jsonData));
                        })
                        .catch(error => {
                            console.error('Error loading SPD.xlsx directly:', error);
                        });
                }
            } catch (e) {
                console.error('Error storing data in localStorage:', e);
            }
            
            // Open the details page with the filter parameter
            const url = `spd_data_details.html?filter=${filterType}`;
            console.log('Opening details page with URL:', url);
            window.open(url, '_blank');
        }
        
        // Sort aging categories in a logical order
        function sortAgingCategories(agingArray) {
            // Define the desired order for aging categories
            const agingOrder = {
                '01 - 10 Days': 1,
                '11 - 30 Days': 2,
                '31 - 100 Days': 3,
                '100+ Days': 4,
                '180+ Days': 5
            };
            
            return agingArray.sort((a, b) => {
                const orderA = agingOrder[a[0]] || 999;
                const orderB = agingOrder[b[0]] || 999;
                return orderA - orderB;
            });
        }
        
        // Create Aging Pie Chart
        function createAgingPieChart() {
            const canvas = document.getElementById('agingPieChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Clear previous chart
            if (agingPieChartInstance) {
                agingPieChartInstance.destroy();
            }
            
            // Prepare data
            let agingEntries = Object.entries(spdAnalysisData.agingCategories);
            agingEntries = sortAgingCategories(agingEntries);
            
            const agingCategories = agingEntries.map(entry => entry[0]);
            const counts = agingEntries.map(entry => entry[1]);
            
            if (agingCategories.length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No aging data available', canvas.width/2, canvas.height/2);
                return;
            }
            
            // Generate colors
            const colors = generateColorfulColors(agingCategories.length);
            
            const data = {
                labels: agingCategories,
                datasets: [{
                    data: counts,
                    backgroundColor: colors.backgroundColors,
                    borderColor: colors.borderColors,
                    borderWidth: 2
                }]
            };
            
            const config = {
                type: 'pie',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 12
                                },
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    return `${label}: ${value}`;
                                }
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 2000,
                        easing: 'easeOutElastic'
                    }
                },
                plugins: [{
                    id: 'pieLabels',
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        chart.data.datasets.forEach((dataset, datasetIndex) => {
                            const meta = chart.getDatasetMeta(datasetIndex);
                            meta.data.forEach((element, index) => {
                                const data = dataset.data[index];
                                
                                const tooltipPos = element.tooltipPosition();
                                ctx.fillStyle = '#fff';
                                ctx.font = 'bold 16px Arial';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                
                                // Add some fun styling - shadow and outline effect
                                ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
                                ctx.shadowBlur = 3;
                                ctx.shadowOffsetX = 2;
                                ctx.shadowOffsetY = 2;
                                
                                // Draw the number with a fun effect
                                ctx.fillText(data, tooltipPos.x, tooltipPos.y);
                                
                                // Reset shadow for next drawing
                                ctx.shadowColor = 'transparent';
                                ctx.shadowBlur = 0;
                                ctx.shadowOffsetX = 0;
                                ctx.shadowOffsetY = 0;
                            });
                        });
                    }
                }]
            };
            
            agingPieChartInstance = new Chart(ctx, config);
        }
        
        // Create Domain Bar Chart (now showing reasons)
        function createDomainBarChart() {
            const canvas = document.getElementById('domainBarChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Clear previous chart
            if (domainBarChartInstance) {
                domainBarChartInstance.destroy();
            }
            
            // Prepare data
            const domainEntries = Object.entries(spdAnalysisData.domains);
            // Sort by count descending
            domainEntries.sort((a, b) => b[1] - a[1]);
            
            const domains = domainEntries.map(entry => entry[0]);
            const counts = domainEntries.map(entry => entry[1]);
            
            if (domains.length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No reason data available', canvas.width/2, canvas.height/2);
                return;
            }
            
            // Generate colors
            const colors = generateColorfulColors(domains.length);
            
            const data = {
                labels: domains,
                datasets: [{
                    label: 'Alarm Count',
                    data: counts,
                    backgroundColor: colors.backgroundColors,
                    borderColor: colors.borderColors,
                    borderWidth: 2
                }]
            };
            
            const config = {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Alarms: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                // Enhanced X-axis label visibility as per project specification
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                },
                                color: '#333'
                            }
                        }
                    },
                    animation: {
                        duration: 2000,
                        easing: 'easeOutBounce'
                    }
                },
                plugins: [{
                    id: 'barLabels',
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        chart.data.datasets.forEach((dataset, datasetIndex) => {
                            const meta = chart.getDatasetMeta(datasetIndex);
                            meta.data.forEach((bar, index) => {
                                const data = dataset.data[index];
                                // 7-segment display style for bar chart numbers
                                ctx.fillStyle = '#000'; // Black color for better visibility
                                ctx.font = 'bold 17px "Orbitron", "Digital7", "Courier New", monospace'; // 7-segment display font with fallbacks
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                
                                // Add shadow effect for better visibility
                                ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
                                ctx.shadowBlur = 3;
                                ctx.shadowOffsetX = 2;
                                ctx.shadowOffsetY = 2;
                                
                                // Position in the middle of the bar
                                const barBase = chart.chartArea.bottom; // Base of the bar (bottom of chart area)
                                const barTop = bar.y; // Top of the bar
                                const barMiddle = (barBase + barTop) / 2; // True middle of the bar
                                
                                ctx.fillText(data, bar.x, barMiddle);
                                
                                // Reset shadow for next drawing
                                ctx.shadowColor = 'transparent';
                                ctx.shadowBlur = 0;
                                ctx.shadowOffsetX = 0;
                                ctx.shadowOffsetY = 0;
                            });
                        });
                    }
                }]
            };
            
            domainBarChartInstance = new Chart(ctx, config);
        }
        
        // Create Region Bar Chart
        function createRegionBarChart() {
            const canvas = document.getElementById('regionBarChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Clear previous chart
            if (regionBarChartInstance) {
                regionBarChartInstance.destroy();
            }
            
            // Prepare data
            const regionEntries = Object.entries(spdAnalysisData.regions);
            // Sort by count descending
            regionEntries.sort((a, b) => b[1] - a[1]);
            
            const regions = regionEntries.map(entry => entry[0]);
            const counts = regionEntries.map(entry => entry[1]);
            
            if (regions.length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No region data available', canvas.width/2, canvas.height/2);
                return;
            }
            
            // Generate colors
            const colors = generateColorfulColors(regions.length);
            
            const data = {
                labels: regions,
                datasets: [{
                    label: 'Alarm Count',
                    data: counts,
                    backgroundColor: colors.backgroundColors,
                    borderColor: colors.borderColors,
                    borderWidth: 2
                }]
            };
            
            const config = {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Alarms: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                // Enhanced X-axis label visibility as per project specification
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                },
                                color: '#333'
                            }
                        }
                    },
                    animation: {
                        duration: 2000,
                        easing: 'easeOutBounce'
                    }
                },
                plugins: [{
                    id: 'barLabels',
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        chart.data.datasets.forEach((dataset, datasetIndex) => {
                            const meta = chart.getDatasetMeta(datasetIndex);
                            meta.data.forEach((bar, index) => {
                                const data = dataset.data[index];
                                // 7-segment display style for bar chart numbers
                                ctx.fillStyle = '#000'; // Black color for better visibility
                                ctx.font = 'bold 17px "Orbitron", "Digital7", "Courier New", monospace'; // 7-segment display font with fallbacks
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                
                                // Add shadow effect for better visibility
                                ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
                                ctx.shadowBlur = 3;
                                ctx.shadowOffsetX = 2;
                                ctx.shadowOffsetY = 2;
                                
                                // Position in the middle of the bar
                                const barBase = chart.chartArea.bottom; // Base of the bar (bottom of chart area)
                                const barTop = bar.y; // Top of the bar
                                const barMiddle = (barBase + barTop) / 2; // True middle of the bar
                                
                                ctx.fillText(data, bar.x, barMiddle);
                                
                                // Reset shadow for next drawing
                                ctx.shadowColor = 'transparent';
                                ctx.shadowBlur = 0;
                                ctx.shadowOffsetX = 0;
                                ctx.shadowOffsetY = 0;
                            });
                        });
                    }
                }]
            };
            
            regionBarChartInstance = new Chart(ctx, config);
        }
        
        // Display all charts
        function displayCharts() {
            createAgingPieChart();
            createDomainBarChart();
            createRegionBarChart();
        }
        
        // Display results
        function displayResults() {
            const resultsSection = document.getElementById('resultsSection');
            if (resultsSection) {
                resultsSection.style.display = 'block';
                displayStats();
                displayCharts();
            }
        }
        
        // Export to Excel
        function exportToExcel() {
            alert('Excel export functionality would export all SPD alarm data to an Excel file.');
            showStatus('üì• Preparing Excel export...', 'loading');
            setTimeout(() => {
                showStatus('‚úÖ Excel export ready', 'success');
            }, 2000);
        }
        
        // Export to PDF
        function exportToPDF() {
            showStatus('üì• Generating PDF report...', 'loading');
            setTimeout(() => {
                showStatus('‚úÖ PDF report ready', 'success');
            }, 2000);
        }
        
        // Initialize with SPD data from Excel
        window.addEventListener('load', function() {
            console.log('=== Initializing SPD Dashboard ===');
            
            // Initialize visit counter
            initVisitCounter();
            
            // Set date
            setPreviousDate();
            
            // Check if we're running locally and provide instructions
            if (window.location.protocol === 'file:') {
                console.log('Running locally with file:// protocol');
                console.log('Note: For best experience, run this dashboard through a local web server');
                console.log('You can use the start_server.bat file or run: python -m http.server 8000');
            }
            
            // Load SPD data from Excel file
            loadSPDData();
            
            showStatus('üì• Loading SPD data from Excel...', 'loading');
        });
    </script>
</body>
</html>